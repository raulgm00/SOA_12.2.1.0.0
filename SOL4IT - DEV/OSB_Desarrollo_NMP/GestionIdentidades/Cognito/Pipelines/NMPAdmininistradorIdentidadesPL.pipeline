<?xml version="1.0" encoding="UTF-8"?>
<con:pipelineEntry xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con4="http://www.bea.com/wli/sb/typesystem/config">
    <con:coreEntry>
        <con:description>Pipeline que permite procesar y enrutar peticiones para crear, borrar, actualizar, activar y desactivar usuarios hacia el provedor de usuarios cognito de Amazon.</con:description>
        <con:binding type="SOAP" isSoap12="false" xsi:type="con:SoapBindingType">
            <con:wsdl ref="GestionIdentidades/Cognito/Resources/WSDLs/NMPAdministradorIdentidadesSvcWSDL"/>
            <con:binding>
                <con:name>NMPAdministradorIdentidades_ptt-binding</con:name>
                <con:namespace>http://servicios.montedepiedad.com.mx/NMP/Service/NMPAdministradorIdentidades</con:namespace>
            </con:binding>
        </con:binding>
        <con:xqConfiguration>
            <con:snippetVersion>1.0</con:snippetVersion>
        </con:xqConfiguration>
    </con:coreEntry>
    <con:router errorHandler="error-N3f57c7ff.N7b1b3e62.0.15e295a5474.N788a">
        <con:pipeline type="request" name="request-N3f57c7ff.594e9c22.0.15c8dc85eb7.N7f9a" errorHandler="error-N53efff49.N36049704.0.15ceca49ad9.N7e00">
            <con:stage id="_StageId-N3f57c7ff.594e9c22.0.15c8dc85eb7.N7f98" name="StageInvocarCognitoCrearUsuario" errorHandler="error-N3f57c7ff.N204ee087.0.15c9cf6b618.N7e0c">
                <con:comment>Gestionar invocación de servicio AWSCognitoIdentityProviderService, operación AdminCreateUser</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="nmp" namespace="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades"/>
                    <con2:userNsDecl prefix="seg" namespace="http://www.bea.com/wli/sb/services/security/config"/>
                    <con4:variable name="amz_json_request" path="$amz_json_request">
                        <con4:xml-schema type="anyType"/>
                    </con4:variable>
                </con:context>
                <con:actions>
                    <con1:wsCallout>
                        <con2:comment>Acciones realizadas antes y después de haber invocado el servicio AWSCognitoIdentityProviderService, operación AdminCreateUser</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N53f5f5de.0.15cc19432b6.N7fc3</con2:id>
                        <con1:service ref="GestionIdentidades/Cognito/Business Services/AMZCognitoProveedorIdentidad" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:request>
                            <con1:payload wrapped="false">amz_crear_usuario_json_request</con1:payload>
                        </con1:request>
                        <con1:response>
                            <con1:payload wrapped="false">amz_crear_usuario_json_response</con1:payload>
                        </con1:response>
                        <con1:requestTransform>
                            <con1:assign varName="amz_xml_request">
                                <con2:comment>Transformar petición XML para crear usuario a la requerida por el servicio AWSCognitoIdentityProviderService, operación AdminCreateUser</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N53f5f5de.0.15cc19432b6.N7f89</con2:id>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRCognitoAdminCrearUsuarioRequest"/>
                                        <con2:param name="idPoolUsuario">
                                            <con2:path>$amz_id_pool_usuario</con2:path>
                                        </con2:param>
                                        <con2:param name="nmpCrearUsuarioRequest">
                                            <con2:path>$body/nmp:crearUsuarioRequest</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:assign>
                            <con1:nxsdTranslation>
                                <con2:comment>Trasladar XML a representación JSON de petición del servicio AWSCognitoIdentityProviderService, operación AdminCreateUser, el resultado será a un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N53f5f5de.0.15cc19432b6.N7f55</con2:id>
                                <con1:type>XML-To-Native</con1:type>
                                <con1:sourceExpr>
                                    <con2:xqueryText>$amz_xml_request</con2:xqueryText>
                                </con1:sourceExpr>
                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:adminCreateUserRequest</con1:schemaElement>
                                <con1:assign-variable>amz_crear_usuario_json_request</con1:assign-variable>
                            </con1:nxsdTranslation>
                            <con1:assign varName="amz_str_json_request">
                                <con2:comment>Obtener cadena de petición JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.4ceb5.0.15d13f54bcd.N7ff8</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_crear_usuario_json_request,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:javaCallout varName=" amz_tam_json_request">
                                <con2:comment>Obtener el tamaño del cuerpo de la petición al servicio AWSCognitoIdentityProviderService, operación AdminCreateUser</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N30dde7d0.0.15e350826ff.N7ffe</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static int obtenerTamanoBytes(java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:javaCallout varName="amz_firma">
                                <con2:comment>Generar firma digital para petición al servicio AWSCognitoIdentityProviderService, operación AdminCreateUser (el tiempo de vida de la firma es de 15 min posterior a la fecha/hora actual).

La generación de la firma se hace utilizando la clase java AmzFirmaAws4.crearFirma, con los siguientes parámetros:

* Cabeceras incluidas en la petición HTTP, cada cabecera deberá incluirse como pares de valores (nombre:valor) separados por coma.
* Método HTTP por el que se realiza la peticion (POST).
* Región para la que se va a generar la firma digital.
* Servicio AWS4 (Amazon Web Service 4) para el que se va a generar la firma digital.
* Clave privada requerida para generar la firma digital.
* Cuerpo de petición en JSON.</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.4ceb5.0.15d13f54bcd.N7ff5</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static java.lang.String crearFirma(java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>fn:concat(
"Content-Length:", $amz_tam_json_request, ",", 
"x-amz-date:", $amz_fecha_hora, ",", 
"Host:", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", ""), ",", 
"Content-Type:application/x-amz-json-1.1; charset=utf-8", ",", 
"x-amz-target:", $amz_operacion_rest
)</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"POST"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", "")</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"cognito-idp"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_clave_secreta/seg:password/text()</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:transport-headers>
                                <con2:comment>Agregar cabeceras http para consumo de servicio AWSCognitoIdentityProviderService.

Requerido especificar las siguienes cabeceras:
* Content-Length
* Content-Type
* Host
* x-amz-date
* x-amz-target
* Authorization</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N53f5f5de.0.15cc19432b6.N7f21</con2:id>
                                <con1:header-set>outbound-request</con1:header-set>
                                <con1:header value="expression" name="Content-Length">
                                    <con2:xqueryText>$amz_tam_json_request</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Content-Type">
                                    <con2:xqueryText>"application/x-amz-json-1.1"</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Host">
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", "")</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-date">
                                    <con2:xqueryText>$amz_fecha_hora</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-target">
                                    <con2:xqueryText>$amz_operacion_rest</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Authorization">
                                    <con2:xqueryText>fn:concat("AWS4-HMAC-SHA256 Credential=", $amz_clave_acceso/seg:password/text(),"/", fn:substring-before($amz_fecha_hora, "T"), "/", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", ""),"/cognito-idp/aws4_request, SignedHeaders=content-length;content-type;host;x-amz-date;x-amz-target, Signature=", $amz_firma)</con2:xqueryText>
                                </con1:header>
                            </con1:transport-headers>
                            <con1:routing-options>
                                <con2:comment>Agregado de las opciones de routeo para el consumo del servicio REST AWSCognitoIdentityProviderService: http-method y Accept</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N53f5f5de.0.15cc19432b6.N7fc0</con2:id>
                                <con1:restOptions>
                                    <con1:verb>POST</con1:verb>
                                    <con1:accept>application/text</con1:accept>
                                </con1:restOptions>
                            </con1:routing-options>
                        </con1:requestTransform>
                        <con1:responseTransform>
                            <con1:assign varName="amz_str_json_response">
                                <con2:comment>Obtener cadena de respuesta JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.4ceb5.0.15d13f54bcd.N7ffe</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_crear_usuario_json_response,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:nxsdTranslation>
                                <con2:comment>Trasladar respuesta JSON  a representación XML del servicio AWSCognitoIdentityProviderService, operación AdminCreateUser</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N53f5f5de.0.15cc19432b6.N7da5</con2:id>
                                <con1:type>Native-To-XML</con1:type>
                                <con1:sourceExpr>
                                    <con2:xqueryText>$amz_str_json_response</con2:xqueryText>
                                </con1:sourceExpr>
                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:adminCreateUserResponse</con1:schemaElement>
                                <con1:assign-variable>amz_xml_response</con1:assign-variable>
                                <con1:enforceSchemaOrder>false</con1:enforceSchemaOrder>
                            </con1:nxsdTranslation>
                            <con1:replace varName="body" contents-only="true">
                                <con2:comment>Transformar respuesta XML del servicio AWSCognitoIdentityProviderService, operación AdminCreateUser a respuesta del servicio AdministradorIdentidades, operación crearUsuario</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.5c079429.0.15cec9c431c.N7ffe</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TROsbCrearUsuarioResponse"/>
                                        <con2:param name="amzDiferenciaHorario">
                                            <con2:path>$amz_diferencia_horario</con2:path>
                                        </con2:param>
                                        <con2:param name="amzAdminCreateUserResponse">
                                            <con2:path>$amz_xml_response</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                        </con1:responseTransform>
                    </con1:wsCallout>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.N204ee087.0.15c9cf6b618.N7e0c">
            <con:stage id="_StageId-N3f57c7ff.N204ee087.0.15c9cf6b618.N7e0b" name="StageManejadorErroresCrearUsuario">
                <con:comment>Manejador de error al gestionar invocación a AWSCognitoIdentityProviderService, operación AdminCreateUser</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="nmp" namespace="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades"/>
                    <con2:userNsDecl prefix="con1" namespace="http://www.bea.com/wli/sb/stages/transform/config"/>
                </con:context>
                <con:actions>
                    <con1:ifThenElse>
                        <con2:comment>Verificar cuando la respuesta sea un error manejado o no por el servicio AWSCognitoIdentityProviderService</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N53f5f5de.0.15cc19432b6.N7ddd</con2:id>
                        <con1:case id="_BranchId-N3f57c7ff.N53f5f5de.0.15cc19432b6.N7ddc">
                            <con1:condition>
                                <con2:xqueryText>fn:exists($fault/ctx:details/con1:ErrorResponseDetail/con1:detail) = fn:true()</con2:xqueryText>
                            </con1:condition>
                            <con1:actions>
                                <con1:ifThenElse>
                                    <con2:comment>Verificar cuando en el detalle de la respuesta existe un binary content</con2:comment>
                                    <con2:id>_ActionId-N3f57c7ff.d04a762.0.15cea5ea7b1.N7d02</con2:id>
                                    <con1:case id="_BranchId-N3f57c7ff.d04a762.0.15cea5ea7b1.N7d01">
                                        <con1:condition>
                                            <con2:xqueryText>fn:contains($fault/ctx:details/con1:ErrorResponseDetail/con1:detail, 'binary-content')</con2:xqueryText>
                                        </con1:condition>
                                        <con1:actions>
                                            <con1:assign varName="amz_str_json_fault">
                                                <con2:comment>Obtener cadena del fallo en JSON de un binary content</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.4ceb5.0.15d13f54bcd.N7ff2</con2:id>
                                                <con1:expr>
                                                    <con2:xqueryText>fn-bea:binary-to-text(fn-bea:inlinedXML($fault/ctx:details/*:ErrorResponseDetail/*:detail),'UTF-8')</con2:xqueryText>
                                                </con1:expr>
                                            </con1:assign>
                                            <con1:nxsdTranslation>
                                                <con2:comment>Trasladar fallo JSON  del servicio AWSCognitoIdentityProviderService a representación XML</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N53f5f5de.0.15cc19432b6.N7e17</con2:id>
                                                <con1:type>Native-To-XML</con1:type>
                                                <con1:sourceExpr>
                                                    <con2:xqueryText>$amz_str_json_fault</con2:xqueryText>
                                                </con1:sourceExpr>
                                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:cognitoIdentityProviderFault</con1:schemaElement>
                                                <con1:assign-variable>amz_xml_fault</con1:assign-variable>
                                                <con1:enforceSchemaOrder>false</con1:enforceSchemaOrder>
                                            </con1:nxsdTranslation>
                                            <con1:replace contents-only="true" varName="body">
                                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.6c3df5f4.0.15cd0d651c3.N7f3e</con2:id>
                                                <con1:location>
                                                    <con2:xpathText>.</con2:xpathText>
                                                </con1:location>
                                                <con1:expr>
                                                    <con2:xsltTransform>
                                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                        <con2:input>$fault</con2:input>
                                                        <con2:param name="servicioConFallo">
                                                            <con2:path>$amz_operacion_rest</con2:path>
                                                        </con2:param>
                                                        <con2:param name="codigoAmazon">
                                                            <con2:path>$amz_xml_fault//*:__type</con2:path>
                                                        </con2:param>
                                                        <con2:param name="mensajeAmazon">
                                                            <con2:path>$amz_xml_fault//*:message</con2:path>
                                                        </con2:param>
                                                    </con2:xsltTransform>
                                                </con1:expr>
                                            </con1:replace>
                                            <con3:report>
                                                <con2:comment>Reportar el usuario que no se pudo crear</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.64c7f85d.0.15da4f81cca.N7ffa</con2:id>
                                                <con3:expr>
                                                    <con2:xqueryText>$amz_xml_fault</con2:xqueryText>
                                                </con3:expr>
                                                <con3:labels>
                                                    <con3:key>Usuario</con3:key>
                                                    <con3:varName>amz_xml_request</con3:varName>
                                                    <con3:value>
                                                        <con2:xpathText>./*:Username</con2:xpathText>
                                                    </con3:value>
                                                </con3:labels>
                                            </con3:report>
                                        </con1:actions>
                                    </con1:case>
                                    <con1:default>
                                        <con1:replace contents-only="true" varName="body">
                                            <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                            <con2:id>_ActionId-N3f57c7ff.d04a762.0.15cea5ea7b1.N7cc6</con2:id>
                                            <con1:location>
                                                <con2:xpathText>.</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xsltTransform>
                                                    <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                    <con2:input>$fault</con2:input>
                                                    <con2:param name="servicioConFallo">
                                                        <con2:path>$amz_operacion_rest</con2:path>
                                                    </con2:param>
                                                    <con2:param name="codigoAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                    <con2:param name="mensajeAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                </con2:xsltTransform>
                                            </con1:expr>
                                        </con1:replace>
                                    </con1:default>
                                </con1:ifThenElse>
                            </con1:actions>
                        </con1:case>
                        <con1:default>
                            <con1:replace contents-only="true" varName="body">
                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.d04a762.0.15cea5ea7b1.N7d9f</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xsltTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                        <con2:input>$fault</con2:input>
                                        <con2:param name="servicioConFallo">
                                            <con2:path>$amz_operacion_rest</con2:path>
                                        </con2:param>
                                        <con2:param name="codigoAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                        <con2:param name="mensajeAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                    </con2:xsltTransform>
                                </con1:expr>
                            </con1:replace>
                        </con1:default>
                    </con1:ifThenElse>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6c3df5f4.0.15cd0d651c3.N7f41</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="response" name="response-N3f57c7ff.594e9c22.0.15c8dc85eb7.N7f99">
            <con:stage id="_StageId-N3f57c7ff.594e9c22.0.15c8dc85eb7.N7f97" name="StageRespuestaCrearUsuario">
                <con:comment>Respuesta exitosa al crear un usuario</con:comment>
                <con:context/>
                <con:actions>
                    <con2:reply>
                        <con2:comment>Notificar respuesta exitosa al crear un usuario</con2:comment>
                        <con2:id>_ActionId-N53efff49.N36049704.0.15ceca49ad9.N7dcc</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="request" name="request-N3f57c7ff.4474d43b.0.15cd6afa54e.N7fcf" errorHandler="error-N3f57c7ff.N2037f314.0.15cf5463ddd.N7d83">
            <con:stage id="_StageId-N3f57c7ff.4474d43b.0.15cd6afa54e.N7fcd" name="StageInvocarCognitoAutenticarUsuario" errorHandler="error-N3f57c7ff.N2037f314.0.15cf5463ddd.N7d50">
                <con:comment>Gestionar invocación de servicio AWSCognitoIdentityProviderService, operación AdminInitiateAuth</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="nmp" namespace="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades"/>
                    <con2:userNsDecl prefix="seg" namespace="http://www.bea.com/wli/sb/services/security/config"/>
                    <con2:userNsDecl prefix="utl" namespace="http://servicios.montedepiedad.com.mx/NMP/Transformations/UtilidadesAmazon"/>
                    <con2:dependencies>
                        <con2:importModule ref="Common/XQ/UtilidadServiciosAmazonXQ"/>
                    </con2:dependencies>
                </con:context>
                <con:actions>
                    <con1:wsCallout>
                        <con2:comment>Acciones realizadas antes y después de haber invocado el servicio AWSCognitoIdentityProviderService, operación AdminInitiateAuth</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7bd6</con2:id>
                        <con1:service ref="GestionIdentidades/Cognito/Business Services/AMZCognitoProveedorIdentidad" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:request>
                            <con1:payload wrapped="false">amz_autenticar_usuario_json_request</con1:payload>
                        </con1:request>
                        <con1:response>
                            <con1:payload wrapped="false">amz_autenticar_usuario_json_response</con1:payload>
                        </con1:response>
                        <con1:requestTransform>
                            <con1:assign varName="amz_xml_request">
                                <con2:comment>Transformar petición XML para autenticar usuario a la requerida por el servicio AWSCognitoIdentityProviderService, operación AdminInitiateAuth</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7644</con2:id>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRCognitoAdminAutenticarUsuarioRequest"/>
                                        <con2:param name="nmpAutenticarUsuarioRequest">
                                            <con2:path>$body/nmp:autenticarUsuarioRequest</con2:path>
                                        </con2:param>
                                        <con2:param name="idCliente">
                                            <con2:path>$amz_id_cliente</con2:path>
                                        </con2:param>
                                        <con2:param name="idPoolUsuario">
                                            <con2:path>$amz_id_pool_usuario</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:assign>
                            <con1:nxsdTranslation>
                                <con2:comment>Trasladar XML a representación JSON de petición del servicio AWSCognitoIdentityProviderService, operación AdminInitiateAuth, el resultado será a un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7c81</con2:id>
                                <con1:type>XML-To-Native</con1:type>
                                <con1:sourceExpr>
                                    <con2:xqueryText>$amz_xml_request</con2:xqueryText>
                                </con1:sourceExpr>
                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:adminInitiateAuthRequest</con1:schemaElement>
                                <con1:assign-variable>amz_autenticar_usuario_json_request</con1:assign-variable>
                            </con1:nxsdTranslation>
                            <con1:assign varName="amz_str_json_request">
                                <con2:comment>Obtener cadena de petición JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7ff2</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_autenticar_usuario_json_request,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:javaCallout varName=" amz_tam_json_request">
                                <con2:comment>Obtener el tamaño del cuerpo de la petición al servicio AWSCognitoIdentityProviderService, operación AdminInitiateAuth</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N30dde7d0.0.15e350826ff.N7ff8</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static int obtenerTamanoBytes(java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:javaCallout varName="amz_firma">
                                <con2:comment>Generar firma digital para petición al servicio AWSCognitoIdentityProviderService, operación AdminInitiateAuth (el tiempo de vida de la firma es de 15 min posterior a la fecha/hora actual).

La generación de la firma se hace utilizando la clase java AmzFirmaAws4.crearFirma:
* Cabeceras incluidas en la petición HTTP, cada cabecera deberá incluirse como pares de valores (nombre:valor) separados por coma.
* Método HTTP por el que se realiza la peticion (POST).
* Región para la que se va a generar la firma digital.
* Servicio AWS4 (Amazon Web Service 4) para el que se va a generar la firma digital.
* Clave privada requerida para generar la firma digital.
* Cuerpo de petición en JSON.</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7fec</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static java.lang.String crearFirma(java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>fn:concat(
"Content-Length:", $amz_tam_json_request, ",", 
"x-amz-date:", $amz_fecha_hora, ",", 
"Host:", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", ""), ",", 
"Content-Type:application/x-amz-json-1.1; charset=utf-8", ",", 
"x-amz-target:", $amz_operacion_rest
)</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"POST"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", "")</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"cognito-idp"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_clave_secreta/seg:password/text()</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:transport-headers>
                                <con2:comment>Agregar cabeceras http para consumo de servicio AWSCognitoIdentityProviderService.

Requerido especificar las siguienes cabeceras:
* Content-Length
* Content-Type
* Host
* x-amz-date
* x-amz-target
* Authorization</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7b96</con2:id>
                                <con1:header-set>outbound-request</con1:header-set>
                                <con1:header value="expression" name="Content-Length">
                                    <con2:xqueryText>$amz_tam_json_request</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Content-Type">
                                    <con2:xqueryText>"application/x-amz-json-1.1"</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Host">
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", "")</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-date">
                                    <con2:xqueryText>$amz_fecha_hora</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-target">
                                    <con2:xqueryText>$amz_operacion_rest</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Authorization">
                                    <con2:xqueryText>fn:concat("AWS4-HMAC-SHA256 Credential=", $amz_clave_acceso/seg:password/text(),"/", fn:substring-before($amz_fecha_hora, "T"), "/", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", ""),"/cognito-idp/aws4_request, SignedHeaders=content-length;content-type;host;x-amz-date;x-amz-target, Signature=", $amz_firma)</con2:xqueryText>
                                </con1:header>
                            </con1:transport-headers>
                            <con1:routing-options>
                                <con2:comment>Agregado de las opciones de routeo para el consumo del servicio REST AWSCognitoIdentityProviderService: http-method y Accept</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7b8f</con2:id>
                                <con1:restOptions>
                                    <con1:verb>POST</con1:verb>
                                    <con1:accept>application/text</con1:accept>
                                </con1:restOptions>
                            </con1:routing-options>
                        </con1:requestTransform>
                        <con1:responseTransform>
                            <con1:assign varName="amz_str_json_response">
                                <con2:comment>Obtener cadena de respuesta JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7ec9</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_autenticar_usuario_json_response,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:nxsdTranslation>
                                <con2:comment>Trasladar respuesta JSON  a representación XML del servicio AWSCognitoIdentityProviderService, operación AdminInitiateAuth</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N767c</con2:id>
                                <con1:type>Native-To-XML</con1:type>
                                <con1:sourceExpr>
                                    <con2:xqueryText>$amz_str_json_response</con2:xqueryText>
                                </con1:sourceExpr>
                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:adminInitiateAuthResponse</con1:schemaElement>
                                <con1:assign-variable>amz_xml_response</con1:assign-variable>
                                <con1:enforceSchemaOrder>false</con1:enforceSchemaOrder>
                            </con1:nxsdTranslation>
                            <con1:replace contents-only="true" varName="body">
                                <con2:comment>Transformar respuesta XML del servicio AWSCognitoIdentityProviderService, operación AdminInitiateAuth a respuesta del servicio AdministradorIdentidades, operación autenticarUsuario</con2:comment>
                                <con2:id>_ActionId-N53effeee.7d06f8eb.0.15cf984048e.N7ffe</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TROsbAutenticarUsuarioResponse"/>
                                        <con2:param name="amzAdminInitiateAuthResponse">
                                            <con2:path>$amz_xml_response</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                        </con1:responseTransform>
                    </con1:wsCallout>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="response" name="response-N3f57c7ff.4474d43b.0.15cd6afa54e.N7fce">
            <con:stage id="_StageId-N3f57c7ff.N2885091.0.15cef903ac2.N7abb" name="StageRespuestaAutenticarUsuario">
                <con:comment>Respuesta exitosa al autenticar un usuario</con:comment>
                <con:context/>
                <con:actions>
                    <con2:reply>
                        <con2:comment>Notificar respuesta exitosa al autenticar un usuario</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2885091.0.15cef903ac2.N7aba</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="request" name="request-N3f57c7ff.d04a762.0.15cea5ea7b1.N7fcf" errorHandler="error-N3f57c7ff.N2037f314.0.15cf5463ddd.N7db6">
            <con:stage id="_StageId-N3f57c7ff.d04a762.0.15cea5ea7b1.N7fcd" name="StageInvocarCognitoBorrarUsuario" errorHandler="error-N3f57c7ff.N2037f314.0.15cf5463ddd.N7de9">
                <con:comment>Gestionar invocación de servicio AWSCognitoIdentityProviderService, operación AdminDeleteUser</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="nmp" namespace="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades"/>
                    <con2:userNsDecl prefix="seg" namespace="http://www.bea.com/wli/sb/services/security/config"/>
                </con:context>
                <con:actions>
                    <con1:wsCallout>
                        <con2:comment>Acciones realizadas antes y después de haber invocado el servicio AWSCognitoIdentityProviderService, operación AdminDeleteUser</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7c0d</con2:id>
                        <con1:service ref="GestionIdentidades/Cognito/Business Services/AMZCognitoProveedorIdentidad" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:request>
                            <con1:payload wrapped="false">amz_borrar_usuario_json_request</con1:payload>
                        </con1:request>
                        <con1:response>
                            <con1:payload wrapped="false">amz_borrar_usuario_json_response</con1:payload>
                        </con1:response>
                        <con1:requestTransform>
                            <con1:assign varName="amz_xml_request">
                                <con2:comment>Transformar petición XML para borrar usuario a la requerida por el servicio AWSCognitoIdentityProviderService, operación AdminDeleteUser</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7e81</con2:id>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRCognitoAdminBorrarUsuarioRequest"/>
                                        <con2:param name="nmpBorrarUsuarioRequest">
                                            <con2:path>$body/nmp:borrarUsuarioRequest</con2:path>
                                        </con2:param>
                                        <con2:param name="idPoolUsuario">
                                            <con2:path>$amz_id_pool_usuario</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:assign>
                            <con1:nxsdTranslation>
                                <con2:comment>Trasladar XML a representación JSON de petición del servicio AWSCognitoIdentityProviderService, operación AdminDeleteUser, el resultado será a un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7cb5</con2:id>
                                <con1:type>XML-To-Native</con1:type>
                                <con1:sourceExpr>
                                    <con2:xqueryText>$amz_xml_request</con2:xqueryText>
                                </con1:sourceExpr>
                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:adminDeleteUserRequest</con1:schemaElement>
                                <con1:assign-variable>amz_borrar_usuario_json_request</con1:assign-variable>
                            </con1:nxsdTranslation>
                            <con1:assign varName="amz_str_json_request">
                                <con2:comment>Obtener cadena de petición JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7ffe</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_borrar_usuario_json_request,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:javaCallout varName=" amz_tam_json_request">
                                <con2:comment>Obtener el tamaño del cuerpo de la petición al servicio AWSCognitoIdentityProviderService, operación AdminDeleteUser</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N30dde7d0.0.15e350826ff.N7ffb</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static int obtenerTamanoBytes(java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:javaCallout varName="amz_firma">
                                <con2:comment>Generar firma digital para petición al servicio AWSCognitoIdentityProviderService, operación AdminDeleteUser (el tiempo de vida de la firma es de 15 min posterior a la fecha/hora actual).

La generación de la firma se hace utilizando la clase java AmzFirmaAws4.crearFirma:
* Cabeceras incluidas en la petición HTTP, cada cabecera deberá incluirse como pares de valores (nombre:valor) separados por coma.
* Método HTTP por el que se realiza la peticion (POST).
* Región para la que se va a generar la firma digital.
* Servicio AWS4 (Amazon Web Service 4) para el que se va a generar la firma digital.
* Clave privada requerida para generar la firma digital.
* Cuerpo de petición en JSON.</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7ff8</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static java.lang.String crearFirma(java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>fn:concat(
"Content-Length:", $amz_tam_json_request, ",", 
"x-amz-date:", $amz_fecha_hora, ",", 
"Host:", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", ""), ",", 
"Content-Type:application/x-amz-json-1.1; charset=utf-8", ",", 
"x-amz-target:", $amz_operacion_rest
)</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"POST"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", "")</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"cognito-idp"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_clave_secreta/seg:password/text()</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:transport-headers>
                                <con2:comment>Agregar cabeceras http para consumo de servicio AWSCognitoIdentityProviderService.

Requerido especificar las siguienes cabeceras:
* Content-Length
* Content-Type
* Host
* x-amz-date
* x-amz-target
* Authorization</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7b98</con2:id>
                                <con1:header-set>outbound-request</con1:header-set>
                                <con1:header value="expression" name="Content-Length">
                                    <con2:xqueryText>$amz_tam_json_request</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Content-Type">
                                    <con2:xqueryText>"application/x-amz-json-1.1"</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Host">
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", "")</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-date">
                                    <con2:xqueryText>$amz_fecha_hora</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-target">
                                    <con2:xqueryText>$amz_operacion_rest</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Authorization">
                                    <con2:xqueryText>fn:concat("AWS4-HMAC-SHA256 Credential=", $amz_clave_acceso/seg:password/text(),"/", fn:substring-before($amz_fecha_hora, "T"), "/", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", ""),"/cognito-idp/aws4_request, SignedHeaders=content-length;content-type;host;x-amz-date;x-amz-target, Signature=", $amz_firma)</con2:xqueryText>
                                </con1:header>
                            </con1:transport-headers>
                            <con1:routing-options>
                                <con2:comment>Agregado de las opciones de routeo para el consumo del servicio REST AWSCognitoIdentityProviderService: http-method y Accept</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7b91</con2:id>
                                <con1:restOptions>
                                    <con1:verb>POST</con1:verb>
                                    <con1:accept>application/text</con1:accept>
                                </con1:restOptions>
                            </con1:routing-options>
                        </con1:requestTransform>
                        <con1:responseTransform>
                            <con1:assign varName="amz_str_json_response">
                                <con2:comment>Obtener cadena de respuesta JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7efd</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_borrar_usuario_json_response,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:replace varName="body" contents-only="true">
                                <con2:comment>generar respuesta del servicio AdministradorIdentidades, operación borrarUsuario</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N760e</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryText>&lt;borrarUsuarioResponse xmlns="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades">
  &lt;confirmacion>OK&lt;/confirmacion>
&lt;/borrarUsuarioResponse></con2:xqueryText>
                                </con1:expr>
                            </con1:replace>
                        </con1:responseTransform>
                    </con1:wsCallout>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="response" name="response-N3f57c7ff.d04a762.0.15cea5ea7b1.N7fce">
            <con:stage id="_StageId-N3f57c7ff.N2885091.0.15cef903ac2.N7b52" name="StageRespuestaBorrarUsuario">
                <con:comment>Respuesta exitosa al borrar un usuario</con:comment>
                <con:context/>
                <con:actions>
                    <con2:reply>
                        <con2:comment>Notificar respuesta exitosa al borrar un usuario</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2885091.0.15cef903ac2.N7b51</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="request" name="request-N3f57c7ff.d04a762.0.15cea5ea7b1.N7f9a" errorHandler="error-N3f57c7ff.N2037f314.0.15cf5463ddd.N7cea">
            <con:stage id="_StageId-N3f57c7ff.d04a762.0.15cea5ea7b1.N7f98" name="StageInvocarCognitoActualizarParamAutenticacion" errorHandler="error-N3f57c7ff.N2037f314.0.15cf5463ddd.N7d1d">
                <con:comment>Gestionar invocación de servicio AWSCognitoIdentityProviderService, operación AdminRespondToAuthChallenge</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="nmp" namespace="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades"/>
                    <con2:userNsDecl prefix="seg" namespace="http://www.bea.com/wli/sb/services/security/config"/>
                </con:context>
                <con:actions>
                    <con1:wsCallout>
                        <con2:comment>Acciones realizadas antes y después de haber invocado el servicio AWSCognitoIdentityProviderService, operación AdminRespondToAuthChallenge</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7b9f</con2:id>
                        <con1:service ref="GestionIdentidades/Cognito/Business Services/AMZCognitoProveedorIdentidad" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:request>
                            <con1:payload wrapped="false">amz_cambios_aut_json_request</con1:payload>
                        </con1:request>
                        <con1:response>
                            <con1:payload wrapped="false">amz_cambios_aut_json_response</con1:payload>
                        </con1:response>
                        <con1:requestTransform>
                            <con1:assign varName="amz_xml_request">
                                <con2:comment>Transformar petición XML para actualizar parametros de autenticación requerida por el servicio AWSCognitoIdentityProviderService, operación AdminRespondToAuthChallenge</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7611</con2:id>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRCognitoCambiosParamAutRequest"/>
                                        <con2:param name="nmpCambiosAutenticacionRequest">
                                            <con2:path>$body/nmp:actualizarParamAutenticacionRequest</con2:path>
                                        </con2:param>
                                        <con2:param name="idCliente">
                                            <con2:path>$amz_id_cliente</con2:path>
                                        </con2:param>
                                        <con2:param name="idPoolUsuario">
                                            <con2:path>$amz_id_pool_usuario</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:assign>
                            <con1:nxsdTranslation>
                                <con2:comment>Trasladar XML a representación JSON de petición del servicio AWSCognitoIdentityProviderService, operación AdminRespondToAuthChallenge, el resultado será a un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7c7f</con2:id>
                                <con1:type>XML-To-Native</con1:type>
                                <con1:sourceExpr>
                                    <con2:xqueryText>$amz_xml_request</con2:xqueryText>
                                </con1:sourceExpr>
                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:adminRespondToAuthChallengeRequest</con1:schemaElement>
                                <con1:assign-variable>amz_cambios_aut_json_request</con1:assign-variable>
                            </con1:nxsdTranslation>
                            <con1:assign varName="amz_str_json_request">
                                <con2:comment>Obtener cadena de petición JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7fe4</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_cambios_aut_json_request,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:javaCallout varName=" amz_tam_json_request">
                                <con2:comment>Obtener el tamaño del cuerpo de la petición al servicio AWSCognitoIdentityProviderService, operación AdminRespondToAuthChallenge</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N30dde7d0.0.15e350826ff.N7ff5</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static int obtenerTamanoBytes(java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:javaCallout varName="amz_firma">
                                <con2:comment>Generar firma digital para petición al servicio AWSCognitoIdentityProviderService, operación AdminRespondToAuthChallenge (el tiempo de vida de la firma es de 15 min posterior a la fecha/hora actual).

La generación de la firma se hace utilizando la clase java AmzFirmaAws4.crearFirma:
* Cabeceras incluidas en la petición HTTP, cada cabecera deberá incluirse como pares de valores (nombre:valor) separados por coma.
* Método HTTP por el que se realiza la peticion (POST).
* Región para la que se va a generar la firma digital.
* Servicio AWS4 (Amazon Web Service 4) para el que se va a generar la firma digital.
* Clave privada requerida para generar la firma digital.
* Cuerpo de petición en JSON.</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7fde</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static java.lang.String crearFirma(java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>fn:concat(
"Content-Length:", $amz_tam_json_request, ",", 
"x-amz-date:", $amz_fecha_hora, ",", 
"Host:", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", ""), ",", 
"Content-Type:application/x-amz-json-1.1; charset=utf-8", ",", 
"x-amz-target:", $amz_operacion_rest
)</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"POST"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", "")</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"cognito-idp"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_clave_secreta/seg:password/text()</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:transport-headers>
                                <con2:comment>Agregar cabeceras http para consumo de servicio AWSCognitoIdentityProviderService.

Requerido especificar las siguienes cabeceras:
* Content-Length
* Content-Type
* Host
* x-amz-date
* x-amz-target
* Authorization</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7b94</con2:id>
                                <con1:header-set>outbound-request</con1:header-set>
                                <con1:header value="expression" name="Content-Length">
                                    <con2:xqueryText>$amz_tam_json_request</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Content-Type">
                                    <con2:xqueryText>"application/x-amz-json-1.1"</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Host">
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", "")</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-date">
                                    <con2:xqueryText>$amz_fecha_hora</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-target">
                                    <con2:xqueryText>$amz_operacion_rest</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Authorization">
                                    <con2:xqueryText>fn:concat("AWS4-HMAC-SHA256 Credential=", $amz_clave_acceso/seg:password/text(),"/", fn:substring-before($amz_fecha_hora, "T"), "/", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", ""),"/cognito-idp/aws4_request, SignedHeaders=content-length;content-type;host;x-amz-date;x-amz-target, Signature=", $amz_firma)</con2:xqueryText>
                                </con1:header>
                            </con1:transport-headers>
                            <con1:routing-options>
                                <con2:comment>Agregado de las opciones de routeo para el consumo del servicio REST AWSCognitoIdentityProviderService: http-method y Accept</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7b8d</con2:id>
                                <con1:restOptions>
                                    <con1:verb>POST</con1:verb>
                                    <con1:accept>application/text</con1:accept>
                                </con1:restOptions>
                            </con1:routing-options>
                        </con1:requestTransform>
                        <con1:responseTransform>
                            <con1:assign varName="amz_str_json_response">
                                <con2:comment>Obtener cadena de respuesta JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7e94</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_cambios_aut_json_response,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:nxsdTranslation>
                                <con2:comment>Trasladar respuesta JSON  a representación XML del servicio AWSCognitoIdentityProviderService, operación AdminRespondToAuthChallenge</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N767a</con2:id>
                                <con1:type>Native-To-XML</con1:type>
                                <con1:sourceExpr>
                                    <con2:xqueryText>$amz_str_json_response</con2:xqueryText>
                                </con1:sourceExpr>
                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:adminRespondToAuthChallengeResponse</con1:schemaElement>
                                <con1:assign-variable>amz_xml_response</con1:assign-variable>
                                <con1:enforceSchemaOrder>false</con1:enforceSchemaOrder>
                            </con1:nxsdTranslation>
                            <con1:replace contents-only="true" varName="body">
                                <con2:comment>Transformar respuesta XML del servicio AWSCognitoIdentityProviderService, operación AdminRespondToAuthChallenge a respuesta del servicio AdministradorIdentidades, operación actualizarParamAutenticacion</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7ffe</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TROsbCambiosParamAutResponse"/>
                                        <con2:param name="amzAdminRespondToAuthChallengeResponse">
                                            <con2:path>$amz_xml_response</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                        </con1:responseTransform>
                    </con1:wsCallout>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="response" name="response-N3f57c7ff.d04a762.0.15cea5ea7b1.N7f99">
            <con:stage id="_StageId-N3f57c7ff.N2885091.0.15cef903ac2.N7a55" name="StageRespuestaActualizarParamAutenticacion">
                <con:comment>Respuesta exitosa al actualizar de parametros de autenticación</con:comment>
                <con:context/>
                <con:actions>
                    <con2:reply>
                        <con2:comment>Notificar respuesta exitosa al crear un usuario</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2885091.0.15cef903ac2.N7a54</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N53efff49.N36049704.0.15ceca49ad9.N7e00">
            <con:stage id="_StageId-N53efff49.N36049704.0.15ceca49ad9.N7d63" name="StageManejadorGeneralErrores">
                <con:comment>Manejador general para los errores ocurridos en el flujo de petición para la creación de un usuario en AWSCognitoIdentityProviderService</con:comment>
                <con:context/>
                <con:actions>
                    <con1:replace contents-only="true" varName="body">
                        <con2:comment>Manejar error que no se pudo manejar en los manejadores a nivel stage</con2:comment>
                        <con2:id>_ActionId-N53efff49.N36049704.0.15ceca49ad9.N7d62</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xsltTransform>
                                <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                <con2:input>$fault</con2:input>
                                <con2:param name="servicioConFallo">
                                    <con2:path>'AdministradorIdentidades.crearUsuario'</con2:path>
                                </con2:param>
                                <con2:param name="codigoAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                                <con2:param name="mensajeAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                            </con2:xsltTransform>
                        </con1:expr>
                    </con1:replace>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N53efff49.N36049704.0.15ceca49ad9.N7d61</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.N2037f314.0.15cf5463ddd.N7de9">
            <con:stage id="_StageId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7955" name="StageManejadorErroresBorrarUsuario">
                <con:comment>Manejador de error al gestionar invocación a AWSCognitoIdentityProviderService, operación AdminDeleteUser</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="nmp" namespace="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades"/>
                    <con2:userNsDecl prefix="con1" namespace="http://www.bea.com/wli/sb/stages/transform/config"/>
                </con:context>
                <con:actions>
                    <con1:ifThenElse>
                        <con2:comment>Verificar cuando la respuesta sea un error manejado o no por el servicio AWSCognitoIdentityProviderService</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7954</con2:id>
                        <con1:case id="_BranchId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7953">
                            <con1:condition>
                                <con2:xqueryText>fn:exists($fault/ctx:details/con1:ErrorResponseDetail/con1:detail) = fn:true()</con2:xqueryText>
                            </con1:condition>
                            <con1:actions>
                                <con1:ifThenElse>
                                    <con2:comment>Verificar cuando en el detalle de la respuesta existe un binary content</con2:comment>
                                    <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7952</con2:id>
                                    <con1:case id="_BranchId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7951">
                                        <con1:condition>
                                            <con2:xqueryText>fn:contains($fault/ctx:details/con1:ErrorResponseDetail/con1:detail, 'binary-content')</con2:xqueryText>
                                        </con1:condition>
                                        <con1:actions>
                                            <con1:assign varName="amz_str_json_fault">
                                                <con2:comment>Obtener cadena del fallo en JSON de un binary content</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7ff5</con2:id>
                                                <con1:expr>
                                                    <con2:xqueryText>fn-bea:binary-to-text(fn-bea:inlinedXML($fault/ctx:details/*:ErrorResponseDetail/*:detail),'UTF-8')</con2:xqueryText>
                                                </con1:expr>
                                            </con1:assign>
                                            <con1:nxsdTranslation>
                                                <con2:comment>Trasladar fallo JSON  del servicio AWSCognitoIdentityProviderService a representación XML</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N794f</con2:id>
                                                <con1:type>Native-To-XML</con1:type>
                                                <con1:sourceExpr>
                                                    <con2:xqueryText>$amz_str_json_fault</con2:xqueryText>
                                                </con1:sourceExpr>
                                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:cognitoIdentityProviderFault</con1:schemaElement>
                                                <con1:assign-variable>amz_xml_fault</con1:assign-variable>
                                                <con1:enforceSchemaOrder>false</con1:enforceSchemaOrder>
                                            </con1:nxsdTranslation>
                                            <con1:replace contents-only="true" varName="body">
                                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N794e</con2:id>
                                                <con1:location>
                                                    <con2:xpathText>.</con2:xpathText>
                                                </con1:location>
                                                <con1:expr>
                                                    <con2:xsltTransform>
                                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                        <con2:input>$fault</con2:input>
                                                        <con2:param name="servicioConFallo">
                                                            <con2:path>$amz_operacion_rest</con2:path>
                                                        </con2:param>
                                                        <con2:param name="codigoAmazon">
                                                            <con2:path>$amz_xml_fault//*:__type</con2:path>
                                                        </con2:param>
                                                        <con2:param name="mensajeAmazon">
                                                            <con2:path>$amz_xml_fault//*:message</con2:path>
                                                        </con2:param>
                                                    </con2:xsltTransform>
                                                </con1:expr>
                                            </con1:replace>
                                            <con3:report>
                                                <con2:comment>Reportar el usuario que no se pudo borrar</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.64c7f85d.0.15da4f81cca.N7fc9</con2:id>
                                                <con3:expr>
                                                    <con2:xqueryText>$amz_xml_fault</con2:xqueryText>
                                                </con3:expr>
                                                <con3:labels>
                                                    <con3:key>Usuario</con3:key>
                                                    <con3:varName>amz_xml_request</con3:varName>
                                                    <con3:value>
                                                        <con2:xpathText>./*:Username</con2:xpathText>
                                                    </con3:value>
                                                </con3:labels>
                                            </con3:report>
                                        </con1:actions>
                                    </con1:case>
                                    <con1:default>
                                        <con1:replace contents-only="true" varName="body">
                                            <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                            <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N794d</con2:id>
                                            <con1:location>
                                                <con2:xpathText>.</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xsltTransform>
                                                    <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                    <con2:input>$fault</con2:input>
                                                    <con2:param name="servicioConFallo">
                                                        <con2:path>$amz_operacion_rest</con2:path>
                                                    </con2:param>
                                                    <con2:param name="codigoAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                    <con2:param name="mensajeAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                </con2:xsltTransform>
                                            </con1:expr>
                                        </con1:replace>
                                    </con1:default>
                                </con1:ifThenElse>
                            </con1:actions>
                        </con1:case>
                        <con1:default>
                            <con1:replace contents-only="true" varName="body">
                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N794c</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xsltTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                        <con2:input>$fault</con2:input>
                                        <con2:param name="servicioConFallo">
                                            <con2:path>$amz_operacion_rest</con2:path>
                                        </con2:param>
                                        <con2:param name="codigoAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                        <con2:param name="mensajeAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                    </con2:xsltTransform>
                                </con1:expr>
                            </con1:replace>
                        </con1:default>
                    </con1:ifThenElse>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N794b</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.N2037f314.0.15cf5463ddd.N7db6">
            <con:stage id="_StageId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7af3" name="StageManejadorGeneralErrores">
                <con:comment>Manejador general para los errores ocurridos en el flujo de petición para el borrado de un usuario en AWSCognitoIdentityProviderService</con:comment>
                <con:context/>
                <con:actions>
                    <con1:replace contents-only="true" varName="body">
                        <con2:comment>Manejar error que no se pudo manejar en los manejadores a nivel stage</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7af2</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xsltTransform>
                                <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                <con2:input>$fault</con2:input>
                                <con2:param name="servicioConFallo">
                                    <con2:path>'AdministradorIdentidades.borrarUsuario'</con2:path>
                                </con2:param>
                                <con2:param name="codigoAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                                <con2:param name="mensajeAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                            </con2:xsltTransform>
                        </con1:expr>
                    </con1:replace>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7af1</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.N2037f314.0.15cf5463ddd.N7d83">
            <con:stage id="_StageId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7abb" name="StageManejadorGeneralErrores">
                <con:comment>Manejador general para los errores ocurridos en el flujo de petición para la creación de un usuario en AWSCognitoIdentityProviderService</con:comment>
                <con:context/>
                <con:actions>
                    <con1:replace contents-only="true" varName="body">
                        <con2:comment>Manejar error que no se pudo manejar en los manejadores a nivel stage</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7aba</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xsltTransform>
                                <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                <con2:input>$fault</con2:input>
                                <con2:param name="servicioConFallo">
                                    <con2:path>'AdministradorIdentidades.autenticarUsuario'</con2:path>
                                </con2:param>
                                <con2:param name="codigoAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                                <con2:param name="mensajeAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                            </con2:xsltTransform>
                        </con1:expr>
                    </con1:replace>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7ab9</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.N2037f314.0.15cf5463ddd.N7d50">
            <con:stage id="_StageId-N3f57c7ff.N2037f314.0.15cf5463ddd.N78ed" name="StageManejadorErroresAutenticarUsuario">
                <con:comment>Manejador de error al gestionar invocación a AWSCognitoIdentityProviderService, operación AdminInitiateAuth</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="con1" namespace="http://www.bea.com/wli/sb/stages/transform/config"/>
                </con:context>
                <con:actions>
                    <con1:ifThenElse>
                        <con2:comment>Verificar cuando la respuesta sea un error manejado o no por el servicio AWSCognitoIdentityProviderService</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N78ec</con2:id>
                        <con1:case id="_BranchId-N3f57c7ff.N2037f314.0.15cf5463ddd.N78eb">
                            <con1:condition>
                                <con2:xqueryText>fn:exists($fault/ctx:details/con1:ErrorResponseDetail/con1:detail) = fn:true()</con2:xqueryText>
                            </con1:condition>
                            <con1:actions>
                                <con1:ifThenElse>
                                    <con2:comment>Verificar cuando en el detalle de la respuesta existe un binary content</con2:comment>
                                    <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N78ea</con2:id>
                                    <con1:case id="_BranchId-N3f57c7ff.N2037f314.0.15cf5463ddd.N78e9">
                                        <con1:condition>
                                            <con2:xqueryText>fn:contains($fault/ctx:details/con1:ErrorResponseDetail/con1:detail, 'binary-content')</con2:xqueryText>
                                        </con1:condition>
                                        <con1:actions>
                                            <con1:assign varName="amz_str_json_fault">
                                                <con2:comment>Obtener cadena del fallo en JSON de un binary content</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7fe9</con2:id>
                                                <con1:expr>
                                                    <con2:xqueryText>fn-bea:binary-to-text(fn-bea:inlinedXML($fault/ctx:details/*:ErrorResponseDetail/*:detail),'UTF-8')</con2:xqueryText>
                                                </con1:expr>
                                            </con1:assign>
                                            <con1:nxsdTranslation>
                                                <con2:comment>Trasladar fallo JSON  del servicio AWSCognitoIdentityProviderService a representación XML</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N78e7</con2:id>
                                                <con1:type>Native-To-XML</con1:type>
                                                <con1:sourceExpr>
                                                    <con2:xqueryText>$amz_str_json_fault</con2:xqueryText>
                                                </con1:sourceExpr>
                                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:cognitoIdentityProviderFault</con1:schemaElement>
                                                <con1:assign-variable>amz_xml_fault</con1:assign-variable>
                                                <con1:enforceSchemaOrder>false</con1:enforceSchemaOrder>
                                            </con1:nxsdTranslation>
                                            <con1:replace contents-only="true" varName="body">
                                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N78e6</con2:id>
                                                <con1:location>
                                                    <con2:xpathText>.</con2:xpathText>
                                                </con1:location>
                                                <con1:expr>
                                                    <con2:xsltTransform>
                                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                        <con2:input>$fault</con2:input>
                                                        <con2:param name="servicioConFallo">
                                                            <con2:path>$amz_operacion_rest</con2:path>
                                                        </con2:param>
                                                        <con2:param name="codigoAmazon">
                                                            <con2:path>$amz_xml_fault//*:__type</con2:path>
                                                        </con2:param>
                                                        <con2:param name="mensajeAmazon">
                                                            <con2:path>$amz_xml_fault//*:message</con2:path>
                                                        </con2:param>
                                                    </con2:xsltTransform>
                                                </con1:expr>
                                            </con1:replace>
                                            <con3:report>
                                                <con2:comment>Reportar el usuario que no se pudo autenticar</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.64c7f85d.0.15da4f81cca.N7fc7</con2:id>
                                                <con3:expr>
                                                    <con2:xqueryText>$amz_xml_fault</con2:xqueryText>
                                                </con3:expr>
                                                <con3:labels>
                                                    <con3:key>Usuario</con3:key>
                                                    <con3:varName>amz_xml_request</con3:varName>
                                                    <con3:value>
                                                        <con2:xpathText>./*:AuthParameters/*:USERNAME</con2:xpathText>
                                                    </con3:value>
                                                </con3:labels>
                                            </con3:report>
                                        </con1:actions>
                                    </con1:case>
                                    <con1:default>
                                        <con1:replace contents-only="true" varName="body">
                                            <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                            <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N78e5</con2:id>
                                            <con1:location>
                                                <con2:xpathText>.</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xsltTransform>
                                                    <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                    <con2:input>$fault</con2:input>
                                                    <con2:param name="servicioConFallo">
                                                        <con2:path>$amz_operacion_rest</con2:path>
                                                    </con2:param>
                                                    <con2:param name="codigoAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                    <con2:param name="mensajeAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                </con2:xsltTransform>
                                            </con1:expr>
                                        </con1:replace>
                                    </con1:default>
                                </con1:ifThenElse>
                            </con1:actions>
                        </con1:case>
                        <con1:default>
                            <con1:replace contents-only="true" varName="body">
                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N78e4</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xsltTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                        <con2:input>$fault</con2:input>
                                        <con2:param name="servicioConFallo">
                                            <con2:path>$amz_operacion_rest</con2:path>
                                        </con2:param>
                                        <con2:param name="codigoAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                        <con2:param name="mensajeAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                    </con2:xsltTransform>
                                </con1:expr>
                            </con1:replace>
                        </con1:default>
                    </con1:ifThenElse>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N78e3</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.N2037f314.0.15cf5463ddd.N7d1d">
            <con:stage id="_StageId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7885" name="StageManejadorErroresCambiosAutenticacion">
                <con:comment>Manejador de error al gestionar invocación a AWSCognitoIdentityProviderService, operación AdminRespondToAuthChallenge</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="con1" namespace="http://www.bea.com/wli/sb/stages/transform/config"/>
                </con:context>
                <con:actions>
                    <con1:ifThenElse>
                        <con2:comment>Verificar cuando la respuesta sea un error manejado o no por el servicio AWSCognitoIdentityProviderService</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7884</con2:id>
                        <con1:case id="_BranchId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7883">
                            <con1:condition>
                                <con2:xqueryText>fn:exists($fault/ctx:details/con1:ErrorResponseDetail/con1:detail) = fn:true()</con2:xqueryText>
                            </con1:condition>
                            <con1:actions>
                                <con1:ifThenElse>
                                    <con2:comment>Verificar cuando en el detalle de la respuesta existe un binary content</con2:comment>
                                    <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7882</con2:id>
                                    <con1:case id="_BranchId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7881">
                                        <con1:condition>
                                            <con2:xqueryText>fn:contains($fault/ctx:details/con1:ErrorResponseDetail/con1:detail, 'binary-content')</con2:xqueryText>
                                        </con1:condition>
                                        <con1:actions>
                                            <con1:assign varName="amz_str_json_fault">
                                                <con2:comment>Obtener cadena del fallo en JSON de un binary content</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7faa</con2:id>
                                                <con1:expr>
                                                    <con2:xqueryText>fn-bea:binary-to-text(fn-bea:inlinedXML($fault/ctx:details/*:ErrorResponseDetail/*:detail),'UTF-8')</con2:xqueryText>
                                                </con1:expr>
                                            </con1:assign>
                                            <con1:nxsdTranslation>
                                                <con2:comment>Trasladar fallo JSON  del servicio AWSCognitoIdentityProviderService a representación XML</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N787f</con2:id>
                                                <con1:type>Native-To-XML</con1:type>
                                                <con1:sourceExpr>
                                                    <con2:xqueryText>$amz_str_json_fault</con2:xqueryText>
                                                </con1:sourceExpr>
                                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:cognitoIdentityProviderFault</con1:schemaElement>
                                                <con1:assign-variable>amz_xml_fault</con1:assign-variable>
                                                <con1:enforceSchemaOrder>false</con1:enforceSchemaOrder>
                                            </con1:nxsdTranslation>
                                            <con1:replace contents-only="true" varName="body">
                                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N787e</con2:id>
                                                <con1:location>
                                                    <con2:xpathText>.</con2:xpathText>
                                                </con1:location>
                                                <con1:expr>
                                                    <con2:xsltTransform>
                                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                        <con2:input>$fault</con2:input>
                                                        <con2:param name="servicioConFallo">
                                                            <con2:path>$amz_operacion_rest</con2:path>
                                                        </con2:param>
                                                        <con2:param name="codigoAmazon">
                                                            <con2:path>$amz_xml_fault//*:__type</con2:path>
                                                        </con2:param>
                                                        <con2:param name="mensajeAmazon">
                                                            <con2:path>$amz_xml_fault//*:message</con2:path>
                                                        </con2:param>
                                                    </con2:xsltTransform>
                                                </con1:expr>
                                            </con1:replace>
                                            <con3:report>
                                                <con2:comment>Reportar el usuario que no se pudo actualizar parámetros</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.64c7f85d.0.15da4f81cca.N7fc4</con2:id>
                                                <con3:expr>
                                                    <con2:xqueryText>$amz_xml_fault</con2:xqueryText>
                                                </con3:expr>
                                                <con3:labels>
                                                    <con3:key>Usuario</con3:key>
                                                    <con3:varName>amz_xml_request</con3:varName>
                                                    <con3:value>
                                                        <con2:xpathText>./*:ChallengeResponses/*:USERNAME</con2:xpathText>
                                                    </con3:value>
                                                </con3:labels>
                                            </con3:report>
                                        </con1:actions>
                                    </con1:case>
                                    <con1:default>
                                        <con1:replace contents-only="true" varName="body">
                                            <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                            <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N787d</con2:id>
                                            <con1:location>
                                                <con2:xpathText>.</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xsltTransform>
                                                    <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                    <con2:input>$fault</con2:input>
                                                    <con2:param name="servicioConFallo">
                                                        <con2:path>$amz_operacion_rest</con2:path>
                                                    </con2:param>
                                                    <con2:param name="codigoAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                    <con2:param name="mensajeAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                </con2:xsltTransform>
                                            </con1:expr>
                                        </con1:replace>
                                    </con1:default>
                                </con1:ifThenElse>
                            </con1:actions>
                        </con1:case>
                        <con1:default>
                            <con1:replace contents-only="true" varName="body">
                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N787c</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xsltTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                        <con2:input>$fault</con2:input>
                                        <con2:param name="servicioConFallo">
                                            <con2:path>$amz_operacion_rest</con2:path>
                                        </con2:param>
                                        <con2:param name="codigoAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                        <con2:param name="mensajeAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                    </con2:xsltTransform>
                                </con1:expr>
                            </con1:replace>
                        </con1:default>
                    </con1:ifThenElse>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N787b</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.N2037f314.0.15cf5463ddd.N7cea">
            <con:stage id="_StageId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7a83" name="StageManejadorGeneralErrores">
                <con:comment>Manejador general para los errores ocurridos en el flujo de petición para la actualización de parametros de autenticación en AWSCognitoIdentityProviderService</con:comment>
                <con:context/>
                <con:actions>
                    <con1:replace contents-only="true" varName="body">
                        <con2:comment>Manejar error que no se pudo manejar en los manejadores a nivel stage</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7a82</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xsltTransform>
                                <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                <con2:input>$fault</con2:input>
                                <con2:param name="servicioConFallo">
                                    <con2:path>'AdministradorIdentidades.actualizarParamAutenticacion'</con2:path>
                                </con2:param>
                                <con2:param name="codigoAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                                <con2:param name="mensajeAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                            </con2:xsltTransform>
                        </con1:expr>
                    </con1:replace>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N2037f314.0.15cf5463ddd.N7a81</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="request" name="request-N3f57c7ff.6f621bc4.0.15d097f84e3.N7ebe" errorHandler="error-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e96">
            <con:stage id="_StageId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7eac" name="StageInvocarCognitoActivarUsuario" errorHandler="error-N3f57c7ff.6f621bc4.0.15d097f84e3.N7ea2">
                <con:comment>Gestionar invocación de servicio AWSCognitoIdentityProviderService, operación AdminEnableUser</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="nmp" namespace="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades"/>
                    <con2:userNsDecl prefix="seg" namespace="http://www.bea.com/wli/sb/services/security/config"/>
                </con:context>
                <con:actions>
                    <con1:wsCallout>
                        <con2:comment>Acciones realizadas antes y después de haber invocado el servicio AWSCognitoIdentityProviderService, operación AdminEnableUser</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7eab</con2:id>
                        <con1:service ref="GestionIdentidades/Cognito/Business Services/AMZCognitoProveedorIdentidad" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:request>
                            <con1:payload wrapped="false">amz_activar_usuario_json_request</con1:payload>
                        </con1:request>
                        <con1:response>
                            <con1:payload wrapped="false">amz_activar_usuario_json_response</con1:payload>
                        </con1:response>
                        <con1:requestTransform>
                            <con1:assign varName="amz_xml_request">
                                <con2:comment>Transformar petición XML para activar usuario a la requerida por el servicio AWSCognitoIdentityProviderService, operación AdminEnableUser</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7eaa</con2:id>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRCognitoAdminActivarUsuarioRequest"/>
                                        <con2:param name="nmpActivarUsuarioRequest">
                                            <con2:path>$body/nmp:activarUsuarioRequest</con2:path>
                                        </con2:param>
                                        <con2:param name="idPoolUsuario">
                                            <con2:path>$amz_id_pool_usuario</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:assign>
                            <con1:nxsdTranslation>
                                <con2:comment>Trasladar XML a representación JSON de petición del servicio AWSCognitoIdentityProviderService, operación AdminEnableUser, el resultado será a un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7ea9</con2:id>
                                <con1:type>XML-To-Native</con1:type>
                                <con1:sourceExpr>
                                    <con2:xqueryText>$amz_xml_request</con2:xqueryText>
                                </con1:sourceExpr>
                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:adminEnableUserRequest</con1:schemaElement>
                                <con1:assign-variable>amz_activar_usuario_json_request</con1:assign-variable>
                            </con1:nxsdTranslation>
                            <con1:assign varName="amz_str_json_request">
                                <con2:comment>Obtener cadena de petición JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7f40</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_activar_usuario_json_request,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:javaCallout varName=" amz_tam_json_request">
                                <con2:comment>Obtener el tamaño del cuerpo de la petición al servicio AWSCognitoIdentityProviderService, operación AdminEnableUser</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N30dde7d0.0.15e350826ff.N7ff2</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static int obtenerTamanoBytes(java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:javaCallout varName="amz_firma">
                                <con2:comment>Generar firma digital para petición al servicio AWSCognitoIdentityProviderService, operación AdminEnableUser (el tiempo de vida de la firma es de 15 min posterior a la fecha/hora actual).

La generación de la firma se hace utilizando la clase java AmzFirmaAws4.crearFirma:
* Cabeceras incluidas en la petición HTTP, cada cabecera deberá incluirse como pares de valores (nombre:valor) separados por coma.
* Método HTTP por el que se realiza la peticion (POST).
* Región para la que se va a generar la firma digital.
* Servicio AWS4 (Amazon Web Service 4) para el que se va a generar la firma digital.
* Clave privada requerida para generar la firma digital.
* Cuerpo de petición en JSON.</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7f3a</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static java.lang.String crearFirma(java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>fn:concat(
"Content-Length:", $amz_tam_json_request, ",", 
"x-amz-date:", $amz_fecha_hora, ",", 
"Host:", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", ""), ",", 
"Content-Type:application/x-amz-json-1.1; charset=utf-8", ",", 
"x-amz-target:", $amz_operacion_rest
)</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"POST"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", "")</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"cognito-idp"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_clave_secreta/seg:password/text()</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:transport-headers>
                                <con2:comment>Agregar cabeceras http para consumo de servicio AWSCognitoIdentityProviderService.

Requerido especificar las siguienes cabeceras:
* Content-Length
* Content-Type
* Host
* x-amz-date
* x-amz-target
* Authorization</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7ea6</con2:id>
                                <con1:header-set>outbound-request</con1:header-set>
                                <con1:header value="expression" name="Content-Length">
                                    <con2:xqueryText>$amz_tam_json_request</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Content-Type">
                                    <con2:xqueryText>"application/x-amz-json-1.1"</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Host">
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", "")</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-date">
                                    <con2:xqueryText>$amz_fecha_hora</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-target">
                                    <con2:xqueryText>$amz_operacion_rest</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Authorization">
                                    <con2:xqueryText>fn:concat("AWS4-HMAC-SHA256 Credential=", $amz_clave_acceso/seg:password/text(),"/", fn:substring-before($amz_fecha_hora, "T"), "/", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", ""),"/cognito-idp/aws4_request, SignedHeaders=content-length;content-type;host;x-amz-date;x-amz-target, Signature=", $amz_firma)</con2:xqueryText>
                                </con1:header>
                            </con1:transport-headers>
                            <con1:routing-options>
                                <con2:comment>Agregado de las opciones de routeo para el consumo del servicio REST AWSCognitoIdentityProviderService: http-method y Accept</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7ea5</con2:id>
                                <con1:restOptions>
                                    <con1:verb>POST</con1:verb>
                                    <con1:accept>application/text</con1:accept>
                                </con1:restOptions>
                            </con1:routing-options>
                        </con1:requestTransform>
                        <con1:responseTransform>
                            <con1:assign varName="amz_str_json_response">
                                <con2:comment>Obtener cadena de respuesta JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7e60</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_activar_usuario_json_response,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:replace varName="body" contents-only="true">
                                <con2:comment>generar respuesta del servicio AdministradorIdentidades, operación activarUsuario</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7ea3</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryText>&lt;activarUsuarioResponse xmlns="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades">
  &lt;confirmacion>OK&lt;/confirmacion>
&lt;/activarUsuarioResponse></con2:xqueryText>
                                </con1:expr>
                            </con1:replace>
                        </con1:responseTransform>
                    </con1:wsCallout>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.6f621bc4.0.15d097f84e3.N7ea2">
            <con:stage id="_StageId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7ea1" name="StageManejadorErroresActivarUsuario">
                <con:comment>Manejador de error al gestionar invocación a AWSCognitoIdentityProviderService, operación AdminEnableUser</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="con1" namespace="http://www.bea.com/wli/sb/stages/transform/config"/>
                </con:context>
                <con:actions>
                    <con1:ifThenElse>
                        <con2:comment>Verificar cuando la respuesta sea un error manejado o no por el servicio AWSCognitoIdentityProviderService</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7ea0</con2:id>
                        <con1:case id="_BranchId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e9f">
                            <con1:condition>
                                <con2:xqueryText>fn:exists($fault/ctx:details/con1:ErrorResponseDetail/con1:detail) = fn:true()</con2:xqueryText>
                            </con1:condition>
                            <con1:actions>
                                <con1:ifThenElse>
                                    <con2:comment>Verificar cuando en el detalle de la respuesta existe un binary content</con2:comment>
                                    <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e9e</con2:id>
                                    <con1:case id="_BranchId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e9d">
                                        <con1:condition>
                                            <con2:xqueryText>fn:contains($fault/ctx:details/con1:ErrorResponseDetail/con1:detail, 'binary-content')</con2:xqueryText>
                                        </con1:condition>
                                        <con1:actions>
                                            <con1:assign varName="amz_str_json_fault">
                                                <con2:comment>Obtener cadena del fallo en JSON de un binary content</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7f77</con2:id>
                                                <con1:expr>
                                                    <con2:xqueryText>fn-bea:binary-to-text(fn-bea:inlinedXML($fault/ctx:details/*:ErrorResponseDetail/*:detail),'UTF-8')</con2:xqueryText>
                                                </con1:expr>
                                            </con1:assign>
                                            <con1:nxsdTranslation>
                                                <con2:comment>Trasladar fallo JSON  del servicio AWSCognitoIdentityProviderService a representación XML</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e9b</con2:id>
                                                <con1:type>Native-To-XML</con1:type>
                                                <con1:sourceExpr>
                                                    <con2:xqueryText>$amz_str_json_fault</con2:xqueryText>
                                                </con1:sourceExpr>
                                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:cognitoIdentityProviderFault</con1:schemaElement>
                                                <con1:assign-variable>amz_xml_fault</con1:assign-variable>
                                                <con1:enforceSchemaOrder>false</con1:enforceSchemaOrder>
                                            </con1:nxsdTranslation>
                                            <con1:replace contents-only="true" varName="body">
                                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e9a</con2:id>
                                                <con1:location>
                                                    <con2:xpathText>.</con2:xpathText>
                                                </con1:location>
                                                <con1:expr>
                                                    <con2:xsltTransform>
                                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                        <con2:input>$fault</con2:input>
                                                        <con2:param name="servicioConFallo">
                                                            <con2:path>$amz_operacion_rest</con2:path>
                                                        </con2:param>
                                                        <con2:param name="codigoAmazon">
                                                            <con2:path>$amz_xml_fault//*:__type</con2:path>
                                                        </con2:param>
                                                        <con2:param name="mensajeAmazon">
                                                            <con2:path>$amz_xml_fault//*:message</con2:path>
                                                        </con2:param>
                                                    </con2:xsltTransform>
                                                </con1:expr>
                                            </con1:replace>
                                            <con3:report>
                                                <con2:comment>Reportar el usuario que no se pudo activar</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.64c7f85d.0.15da4f81cca.N7fc2</con2:id>
                                                <con3:expr>
                                                    <con2:xqueryText>$amz_xml_fault</con2:xqueryText>
                                                </con3:expr>
                                                <con3:labels>
                                                    <con3:key>Usuario</con3:key>
                                                    <con3:varName>amz_xml_request</con3:varName>
                                                    <con3:value>
                                                        <con2:xpathText>./*:Username</con2:xpathText>
                                                    </con3:value>
                                                </con3:labels>
                                            </con3:report>
                                        </con1:actions>
                                    </con1:case>
                                    <con1:default>
                                        <con1:replace contents-only="true" varName="body">
                                            <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                            <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e99</con2:id>
                                            <con1:location>
                                                <con2:xpathText>.</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xsltTransform>
                                                    <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                    <con2:input>$fault</con2:input>
                                                    <con2:param name="servicioConFallo">
                                                        <con2:path>$amz_operacion_rest</con2:path>
                                                    </con2:param>
                                                    <con2:param name="codigoAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                    <con2:param name="mensajeAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                </con2:xsltTransform>
                                            </con1:expr>
                                        </con1:replace>
                                    </con1:default>
                                </con1:ifThenElse>
                            </con1:actions>
                        </con1:case>
                        <con1:default>
                            <con1:replace contents-only="true" varName="body">
                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e98</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xsltTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                        <con2:input>$fault</con2:input>
                                        <con2:param name="servicioConFallo">
                                            <con2:path>$amz_operacion_rest</con2:path>
                                        </con2:param>
                                        <con2:param name="codigoAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                        <con2:param name="mensajeAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                    </con2:xsltTransform>
                                </con1:expr>
                            </con1:replace>
                        </con1:default>
                    </con1:ifThenElse>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e97</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e96">
            <con:stage id="_StageId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e95" name="StageManejadorGeneralErrores">
                <con:comment>Manejador general para los errores ocurridos en el flujo de petición para la activación de un usuario en AWSCognitoIdentityProviderService</con:comment>
                <con:context/>
                <con:actions>
                    <con1:replace contents-only="true" varName="body">
                        <con2:comment>Manejar error que no se pudo manejar en los manejadores a nivel stage</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e93</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xsltTransform>
                                <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                <con2:input>$fault</con2:input>
                                <con2:param name="servicioConFallo">
                                    <con2:path>'AdministradorIdentidades.activarUsuario'</con2:path>
                                </con2:param>
                                <con2:param name="codigoAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                                <con2:param name="mensajeAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                            </con2:xsltTransform>
                        </con1:expr>
                    </con1:replace>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e92</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="response" name="response-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e91">
            <con:stage id="_StageId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e90" name="StageRespuestaActivarUsuario">
                <con:comment>Respuesta exitosa al autenticar un usuario</con:comment>
                <con:context/>
                <con:actions>
                    <con2:reply>
                        <con2:comment>Notificar respuesta exitosa al crear un usuario</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e8f</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="request" name="request-N3f57c7ff.6f621bc4.0.15d097f84e3.N7da2" errorHandler="error-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d7a">
            <con:stage id="_StageId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d90" name="StageInvocarCognitoDesactivarUsuario" errorHandler="error-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d86">
                <con:comment>Gestionar invocación de servicio AWSCognitoIdentityProviderService, operación AdminDisableUser</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="nmp" namespace="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades"/>
                    <con2:userNsDecl prefix="seg" namespace="http://www.bea.com/wli/sb/services/security/config"/>
                </con:context>
                <con:actions>
                    <con1:wsCallout>
                        <con2:comment>Acciones realizadas antes y después de haber invocado el servicio AWSCognitoIdentityProviderService, operación AdminDisableUser</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d8f</con2:id>
                        <con1:service ref="GestionIdentidades/Cognito/Business Services/AMZCognitoProveedorIdentidad" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:request>
                            <con1:payload wrapped="false">amz_desactivar_usuario_json_request</con1:payload>
                        </con1:request>
                        <con1:response>
                            <con1:payload wrapped="false">amz_desactivar_usuario_json_response</con1:payload>
                        </con1:response>
                        <con1:requestTransform>
                            <con1:assign varName="amz_xml_request">
                                <con2:comment>Transformar petición XML para desactivar usuario a la requerida por el servicio AWSCognitoIdentityProviderService, operación AdminDisableUser</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d8e</con2:id>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRCognitoAdminDesactivarUsuarioRequest"/>
                                        <con2:param name="nmpDesactivarUsuarioRequest">
                                            <con2:path>$body/nmp:desactivarUsuarioRequest</con2:path>
                                        </con2:param>
                                        <con2:param name="idPoolUsuario">
                                            <con2:path>$amz_id_pool_usuario</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:assign>
                            <con1:nxsdTranslation>
                                <con2:comment>Trasladar XML a representación JSON de petición del servicio AWSCognitoIdentityProviderService, operación AdminDisableUser, el resultado será a un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d8d</con2:id>
                                <con1:type>XML-To-Native</con1:type>
                                <con1:sourceExpr>
                                    <con2:xqueryText>$amz_xml_request</con2:xqueryText>
                                </con1:sourceExpr>
                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:adminDisableUserRequest</con1:schemaElement>
                                <con1:assign-variable>amz_desactivar_usuario_json_request</con1:assign-variable>
                            </con1:nxsdTranslation>
                            <con1:assign varName="amz_str_json_request">
                                <con2:comment>Obtener cadena de petición JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7f37</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_desactivar_usuario_json_request,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:javaCallout varName=" amz_tam_json_request">
                                <con2:comment>Obtener el tamaño del cuerpo de la petición al servicio AWSCognitoIdentityProviderService, operación AdminDisableUser</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N30dde7d0.0.15e350826ff.N7fef</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static int obtenerTamanoBytes(java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:javaCallout varName="amz_firma">
                                <con2:comment>Generar firma digital para petición al servicio AWSCognitoIdentityProviderService, operación AdminDisableUser (el tiempo de vida de la firma es de 15 min posterior a la fecha/hora actual).

La generación de la firma se hace utilizando la clase java AmzFirmaAws4.crearFirma:
* Cabeceras incluidas en la petición HTTP, cada cabecera deberá incluirse como pares de valores (nombre:valor) separados por coma.
* Método HTTP por el que se realiza la peticion (POST).
* Región para la que se va a generar la firma digital.
* Servicio AWS4 (Amazon Web Service 4) para el que se va a generar la firma digital.
* Clave privada requerida para generar la firma digital.
* Cuerpo de petición en JSON.</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7f31</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static java.lang.String crearFirma(java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>fn:concat(
"Content-Length:", $amz_tam_json_request, ",", 
"x-amz-date:", $amz_fecha_hora, ",", 
"Host:", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", ""), ",", 
"Content-Type:application/x-amz-json-1.1; charset=utf-8", ",", 
"x-amz-target:", $amz_operacion_rest
)</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"POST"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", "")</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"cognito-idp"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_clave_secreta/seg:password/text()</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:transport-headers>
                                <con2:comment>Agregar cabeceras http para consumo de servicio AWSCognitoIdentityProviderService.

Requerido especificar las siguienes cabeceras:
* Content-Length
* Content-Type
* Host
* x-amz-date
* x-amz-target
* Authorization</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d8a</con2:id>
                                <con1:header-set>outbound-request</con1:header-set>
                                <con1:header value="expression" name="Content-Length">
                                    <con2:xqueryText>$amz_tam_json_request</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Content-Type">
                                    <con2:xqueryText>"application/x-amz-json-1.1"</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Host">
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", "")</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-date">
                                    <con2:xqueryText>$amz_fecha_hora</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-target">
                                    <con2:xqueryText>$amz_operacion_rest</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Authorization">
                                    <con2:xqueryText>fn:concat("AWS4-HMAC-SHA256 Credential=", $amz_clave_acceso/seg:password/text(),"/", fn:substring-before($amz_fecha_hora, "T"), "/", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", ""),"/cognito-idp/aws4_request, SignedHeaders=content-length;content-type;host;x-amz-date;x-amz-target, Signature=", $amz_firma)</con2:xqueryText>
                                </con1:header>
                            </con1:transport-headers>
                            <con1:routing-options>
                                <con2:comment>Agregado de las opciones de routeo para el consumo del servicio REST AWSCognitoIdentityProviderService: http-method y Accept</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d89</con2:id>
                                <con1:restOptions>
                                    <con1:verb>POST</con1:verb>
                                    <con1:accept>application/text</con1:accept>
                                </con1:restOptions>
                            </con1:routing-options>
                        </con1:requestTransform>
                        <con1:responseTransform>
                            <con1:assign varName="amz_str_json_response">
                                <con2:comment>Obtener cadena de respuesta JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7e2c</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_desactivar_usuario_json_response,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:replace varName="body" contents-only="true">
                                <con2:comment>generar respuesta del servicio AdministradorIdentidades, operación desactivarUsuario</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d87</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryText>&lt;desactivarUsuarioResponse xmlns="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades">
  &lt;confirmacion>OK&lt;/confirmacion>
&lt;/desactivarUsuarioResponse></con2:xqueryText>
                                </con1:expr>
                            </con1:replace>
                        </con1:responseTransform>
                    </con1:wsCallout>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d86">
            <con:stage id="_StageId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d85" name="StageManejadorErroresDesactivarUsuario">
                <con:comment>Manejador de error al gestionar invocación a AWSCognitoIdentityProviderService, operación AdminDisableUser</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="con1" namespace="http://www.bea.com/wli/sb/stages/transform/config"/>
                </con:context>
                <con:actions>
                    <con1:ifThenElse>
                        <con2:comment>Verificar cuando la respuesta sea un error manejado o no por el servicio AWSCognitoIdentityProviderService</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d84</con2:id>
                        <con1:case id="_BranchId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d83">
                            <con1:condition>
                                <con2:xqueryText>fn:exists($fault/ctx:details/con1:ErrorResponseDetail/con1:detail) = fn:true()</con2:xqueryText>
                            </con1:condition>
                            <con1:actions>
                                <con1:ifThenElse>
                                    <con2:comment>Verificar cuando en el detalle de la respuesta existe un binary content</con2:comment>
                                    <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d82</con2:id>
                                    <con1:case id="_BranchId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d81">
                                        <con1:condition>
                                            <con2:xqueryText>fn:contains($fault/ctx:details/con1:ErrorResponseDetail/con1:detail, 'binary-content')</con2:xqueryText>
                                        </con1:condition>
                                        <con1:actions>
                                            <con1:assign varName="amz_str_json_fault">
                                                <con2:comment>Obtener cadena del fallo en JSON de un binary content</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N75cd33a5.0.15d18f8d6f3.N7f44</con2:id>
                                                <con1:expr>
                                                    <con2:xqueryText>fn-bea:binary-to-text(fn-bea:inlinedXML($fault/ctx:details/*:ErrorResponseDetail/*:detail),'UTF-8')</con2:xqueryText>
                                                </con1:expr>
                                            </con1:assign>
                                            <con1:nxsdTranslation>
                                                <con2:comment>Trasladar fallo JSON  del servicio AWSCognitoIdentityProviderService a representación XML</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d7f</con2:id>
                                                <con1:type>Native-To-XML</con1:type>
                                                <con1:sourceExpr>
                                                    <con2:xqueryText>$amz_str_json_fault</con2:xqueryText>
                                                </con1:sourceExpr>
                                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:cognitoIdentityProviderFault</con1:schemaElement>
                                                <con1:assign-variable>amz_xml_fault</con1:assign-variable>
                                                <con1:enforceSchemaOrder>false</con1:enforceSchemaOrder>
                                            </con1:nxsdTranslation>
                                            <con1:replace contents-only="true" varName="body">
                                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d7e</con2:id>
                                                <con1:location>
                                                    <con2:xpathText>.</con2:xpathText>
                                                </con1:location>
                                                <con1:expr>
                                                    <con2:xsltTransform>
                                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                        <con2:input>$fault</con2:input>
                                                        <con2:param name="servicioConFallo">
                                                            <con2:path>$amz_operacion_rest</con2:path>
                                                        </con2:param>
                                                        <con2:param name="codigoAmazon">
                                                            <con2:path>$amz_xml_fault//*:__type</con2:path>
                                                        </con2:param>
                                                        <con2:param name="mensajeAmazon">
                                                            <con2:path>$amz_xml_fault//*:message</con2:path>
                                                        </con2:param>
                                                    </con2:xsltTransform>
                                                </con1:expr>
                                            </con1:replace>
                                            <con3:report>
                                                <con2:comment>Reportar el usuario que no se pudo desactivar</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.64c7f85d.0.15da4f81cca.N7fc0</con2:id>
                                                <con3:expr>
                                                    <con2:xqueryText>$amz_xml_fault</con2:xqueryText>
                                                </con3:expr>
                                                <con3:labels>
                                                    <con3:key>Usuario</con3:key>
                                                    <con3:varName>amz_xml_request</con3:varName>
                                                    <con3:value>
                                                        <con2:xpathText>./*:Username</con2:xpathText>
                                                    </con3:value>
                                                </con3:labels>
                                            </con3:report>
                                        </con1:actions>
                                    </con1:case>
                                    <con1:default>
                                        <con1:replace contents-only="true" varName="body">
                                            <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                            <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d7d</con2:id>
                                            <con1:location>
                                                <con2:xpathText>.</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xsltTransform>
                                                    <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                    <con2:input>$fault</con2:input>
                                                    <con2:param name="servicioConFallo">
                                                        <con2:path>$amz_operacion_rest</con2:path>
                                                    </con2:param>
                                                    <con2:param name="codigoAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                    <con2:param name="mensajeAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                </con2:xsltTransform>
                                            </con1:expr>
                                        </con1:replace>
                                    </con1:default>
                                </con1:ifThenElse>
                            </con1:actions>
                        </con1:case>
                        <con1:default>
                            <con1:replace contents-only="true" varName="body">
                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d7c</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xsltTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                        <con2:input>$fault</con2:input>
                                        <con2:param name="servicioConFallo">
                                            <con2:path>$amz_operacion_rest</con2:path>
                                        </con2:param>
                                        <con2:param name="codigoAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                        <con2:param name="mensajeAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                    </con2:xsltTransform>
                                </con1:expr>
                            </con1:replace>
                        </con1:default>
                    </con1:ifThenElse>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d7b</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d7a">
            <con:stage id="_StageId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d79" name="StageManejadorGeneralErrores">
                <con:comment>Manejador general para los errores ocurridos en el flujo de petición para la desactivación de un usuario en AWSCognitoIdentityProviderService</con:comment>
                <con:context/>
                <con:actions>
                    <con1:replace contents-only="true" varName="body">
                        <con2:comment>Manejar error que no se pudo manejar en los manejadores a nivel stage</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d77</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xsltTransform>
                                <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                <con2:input>$fault</con2:input>
                                <con2:param name="servicioConFallo">
                                    <con2:path>'AdministradorIdentidades.desactivarUsuario'</con2:path>
                                </con2:param>
                                <con2:param name="codigoAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                                <con2:param name="mensajeAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                            </con2:xsltTransform>
                        </con1:expr>
                    </con1:replace>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d76</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="response" name="response-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d75">
            <con:stage id="_StageId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d74" name="StageRespuestaDesactivarUsuario">
                <con:comment>Respuesta exitosa al autenticar un usuario</con:comment>
                <con:context/>
                <con:actions>
                    <con2:reply>
                        <con2:comment>Notificar respuesta exitosa al crear un usuario</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d73</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="request" name="request-N3f57c7ff.N70788676.0.15e0b389659.N7eb2" errorHandler="error-N3f57c7ff.N70788676.0.15e0b389659.N7e87">
            <con:stage id="_StageId-N3f57c7ff.N70788676.0.15e0b389659.N7ea0" name="StageInvocarCognitoBuscarUsuario" errorHandler="error-N3f57c7ff.N70788676.0.15e0b389659.N7e94">
                <con:comment>Gestionar invocación de servicio AWSCognitoIdentityProviderService, operación AdminGetUser</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="nmp" namespace="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades"/>
                    <con2:userNsDecl prefix="seg" namespace="http://www.bea.com/wli/sb/services/security/config"/>
                    <con4:variable name="amz_json_request" path="$amz_json_request">
                        <con4:xml-schema type="anyType"/>
                    </con4:variable>
                </con:context>
                <con:actions>
                    <con1:wsCallout>
                        <con2:comment>Acciones realizadas antes y después de haber invocado el servicio AWSCognitoIdentityProviderService, operación AdminGetUser</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e9f</con2:id>
                        <con1:service ref="GestionIdentidades/Cognito/Business Services/AMZCognitoProveedorIdentidad" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:request>
                            <con1:payload wrapped="false">amz_buscar_usuario_json_request</con1:payload>
                        </con1:request>
                        <con1:response>
                            <con1:payload wrapped="false">amz_buscar_usuario_json_response</con1:payload>
                        </con1:response>
                        <con1:requestTransform>
                            <con1:assign varName="amz_xml_request">
                                <con2:comment>Transformar petición XML para crear usuario a la requerida por el servicio AWSCognitoIdentityProviderService, operación AdminGetUser</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e9e</con2:id>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRCognitoAdminBuscarUsuarioRequest"/>
                                        <con2:param name="nmpBuscarUsuarioRequest">
                                            <con2:path>$body/nmp:buscarUsuarioRequest</con2:path>
                                        </con2:param>
                                        <con2:param name="idPoolUsuario">
                                            <con2:path>$amz_id_pool_usuario</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:assign>
                            <con1:nxsdTranslation>
                                <con2:comment>Trasladar XML a representación JSON de petición del servicio AWSCognitoIdentityProviderService, operación AdminGetUser, el resultado será a un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e9d</con2:id>
                                <con1:type>XML-To-Native</con1:type>
                                <con1:sourceExpr>
                                    <con2:xqueryText>$amz_xml_request</con2:xqueryText>
                                </con1:sourceExpr>
                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:adminGetUserRequest</con1:schemaElement>
                                <con1:assign-variable>amz_buscar_usuario_json_request</con1:assign-variable>
                            </con1:nxsdTranslation>
                            <con1:assign varName="amz_str_json_request">
                                <con2:comment>Obtener cadena de petición JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e9c</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_buscar_usuario_json_request,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:javaCallout varName=" amz_tam_json_request">
                                <con2:comment>Obtener el tamaño del cuerpo de la petición al servicio AWSCognitoIdentityProviderService, operación AdminGetUser</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N30dde7d0.0.15e350826ff.N7fec</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static int obtenerTamanoBytes(java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:javaCallout varName="amz_firma">
                                <con2:comment>Generar firma digital para petición al servicio AWSCognitoIdentityProviderService, operación AdminGetUser (el tiempo de vida de la firma es de 15 min posterior a la fecha/hora actual).

La generación de la firma se hace utilizando la clase java AmzFirmaAws4.crearFirma, con los siguientes parámetros:

* Cabeceras incluidas en la petición HTTP, cada cabecera deberá incluirse como pares de valores (nombre:valor) separados por coma.
* Método HTTP por el que se realiza la peticion (POST).
* Región para la que se va a generar la firma digital.
* Servicio AWS4 (Amazon Web Service 4) para el que se va a generar la firma digital.
* Clave privada requerida para generar la firma digital.
* Cuerpo de petición en JSON.</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e9a</con2:id>
                                <con1:archive ref="GestionIdentidades/Cognito/Resources/JARs/utilidadesAmzAws"/>
                                <con1:className>amzutiliadesaws.AmzFirmaAws4</con1:className>
                                <con1:method>public static java.lang.String crearFirma(java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String)</con1:method>
                                <con1:expr>
                                    <con2:xqueryText>fn:concat(
"Content-Length:", $amz_tam_json_request, ",", 
"x-amz-date:", $amz_fecha_hora, ",", 
"Host:", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", ""), ",", 
"Content-Type:application/x-amz-json-1.1; charset=utf-8", ",", 
"x-amz-target:", $amz_operacion_rest
)</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"POST"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", "")</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>"cognito-idp"</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_clave_secreta/seg:password/text()</con2:xqueryText>
                                </con1:expr>
                                <con1:expr>
                                    <con2:xqueryText>$amz_str_json_request</con2:xqueryText>
                                </con1:expr>
                                <con1:return-param-as-ref>false</con1:return-param-as-ref>
                            </con1:javaCallout>
                            <con1:transport-headers>
                                <con2:comment>Agregar cabeceras http para consumo de servicio AWSCognitoIdentityProviderService.

Requerido especificar las siguienes cabeceras:
* Content-Length
* Content-Type
* Host
* x-amz-date
* x-amz-target
* Authorization</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e99</con2:id>
                                <con1:header-set>outbound-request</con1:header-set>
                                <con1:header value="expression" name="Content-Length">
                                    <con2:xqueryText>$amz_tam_json_request</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Content-Type">
                                    <con2:xqueryText>"application/x-amz-json-1.1"</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Host">
                                    <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "host", "")</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-date">
                                    <con2:xqueryText>$amz_fecha_hora</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="x-amz-target">
                                    <con2:xqueryText>$amz_operacion_rest</con2:xqueryText>
                                </con1:header>
                                <con1:header value="expression" name="Authorization">
                                    <con2:xqueryText>fn:concat("AWS4-HMAC-SHA256 Credential=", $amz_clave_acceso/seg:password/text(),"/", fn:substring-before($amz_fecha_hora, "T"), "/", dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "region", ""),"/cognito-idp/aws4_request, SignedHeaders=content-length;content-type;host;x-amz-date;x-amz-target, Signature=", $amz_firma)</con2:xqueryText>
                                </con1:header>
                            </con1:transport-headers>
                            <con1:routing-options>
                                <con2:comment>Agregado de las opciones de routeo para el consumo del servicio REST AWSCognitoIdentityProviderService: http-method y Accept</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e98</con2:id>
                                <con1:restOptions>
                                    <con1:verb>POST</con1:verb>
                                    <con1:accept>application/text</con1:accept>
                                </con1:restOptions>
                            </con1:routing-options>
                        </con1:requestTransform>
                        <con1:responseTransform>
                            <con1:assign varName="amz_str_json_response">
                                <con2:comment>Obtener cadena de respuesta JSON de un binary content</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e97</con2:id>
                                <con1:expr>
                                    <con2:xqueryText>fn-bea:binary-to-text($amz_buscar_usuario_json_response,'UTF-8')</con2:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:nxsdTranslation>
                                <con2:comment>Trasladar respuesta JSON  a representación XML del servicio AWSCognitoIdentityProviderService, operación AdminGetUser</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e96</con2:id>
                                <con1:type>Native-To-XML</con1:type>
                                <con1:sourceExpr>
                                    <con2:xqueryText>$amz_str_json_response</con2:xqueryText>
                                </con1:sourceExpr>
                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:adminGetUserResponse</con1:schemaElement>
                                <con1:assign-variable>amz_xml_response</con1:assign-variable>
                                <con1:enforceSchemaOrder>false</con1:enforceSchemaOrder>
                            </con1:nxsdTranslation>
                            <con1:replace varName="body" contents-only="true">
                                <con2:comment>Transformar respuesta XML del servicio AWSCognitoIdentityProviderService, operación AdminGetUser a respuesta del servicio AdministradorIdentidades, operación buscarUsuario</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e95</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xqueryTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TROsbBuscarUsuarioResponse"/>
                                        <con2:param name="amzDiferenciaHorario">
                                            <con2:path>$amz_diferencia_horario</con2:path>
                                        </con2:param>
                                        <con2:param name="amzAdminGetUserResponse">
                                            <con2:path>$amz_xml_response</con2:path>
                                        </con2:param>
                                    </con2:xqueryTransform>
                                </con1:expr>
                            </con1:replace>
                        </con1:responseTransform>
                    </con1:wsCallout>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.N70788676.0.15e0b389659.N7e94">
            <con:stage id="_StageId-N3f57c7ff.N70788676.0.15e0b389659.N7e93" name="StageManejadorErroresBuscarUsuario">
                <con:comment>Manejador de error al gestionar invocación a AWSCognitoIdentityProviderService, operación AdminGetUser</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="nmp" namespace="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPAdministradorIdentidades"/>
                    <con2:userNsDecl prefix="con1" namespace="http://www.bea.com/wli/sb/stages/transform/config"/>
                </con:context>
                <con:actions>
                    <con1:ifThenElse>
                        <con2:comment>Verificar cuando la respuesta sea un error manejado o no por el servicio AWSCognitoIdentityProviderService</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e92</con2:id>
                        <con1:case id="_BranchId-N3f57c7ff.N70788676.0.15e0b389659.N7e91">
                            <con1:condition>
                                <con2:xqueryText>fn:exists($fault/ctx:details/con1:ErrorResponseDetail/con1:detail) = fn:true()</con2:xqueryText>
                            </con1:condition>
                            <con1:actions>
                                <con1:ifThenElse>
                                    <con2:comment>Verificar cuando en el detalle de la respuesta existe un binary content</con2:comment>
                                    <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e90</con2:id>
                                    <con1:case id="_BranchId-N3f57c7ff.N70788676.0.15e0b389659.N7e8f">
                                        <con1:condition>
                                            <con2:xqueryText>fn:contains($fault/ctx:details/con1:ErrorResponseDetail/con1:detail, 'binary-content')</con2:xqueryText>
                                        </con1:condition>
                                        <con1:actions>
                                            <con1:assign varName="amz_str_json_fault">
                                                <con2:comment>Obtener cadena del fallo en JSON de un binary content</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e8e</con2:id>
                                                <con1:expr>
                                                    <con2:xqueryText>fn-bea:binary-to-text(fn-bea:inlinedXML($fault/ctx:details/*:ErrorResponseDetail/*:detail),'UTF-8')</con2:xqueryText>
                                                </con1:expr>
                                            </con1:assign>
                                            <con1:nxsdTranslation>
                                                <con2:comment>Trasladar fallo JSON  del servicio AWSCognitoIdentityProviderService a representación XML</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e8d</con2:id>
                                                <con1:type>Native-To-XML</con1:type>
                                                <con1:sourceExpr>
                                                    <con2:xqueryText>$amz_str_json_fault</con2:xqueryText>
                                                </con1:sourceExpr>
                                                <con1:nxsd ref="GestionIdentidades/Cognito/Resources/Schemas/AMZCognitoProveedorIdentidadNXSD"/>
                                                <con1:schemaElement xmlns:amz="http://servicios.montedepiedad.com.mx/NMP/Schema/AMZCognitoProveedorIdentidad">amz:cognitoIdentityProviderFault</con1:schemaElement>
                                                <con1:assign-variable>amz_xml_fault</con1:assign-variable>
                                                <con1:enforceSchemaOrder>false</con1:enforceSchemaOrder>
                                            </con1:nxsdTranslation>
                                            <con1:replace contents-only="true" varName="body">
                                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e8c</con2:id>
                                                <con1:location>
                                                    <con2:xpathText>.</con2:xpathText>
                                                </con1:location>
                                                <con1:expr>
                                                    <con2:xsltTransform>
                                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                        <con2:input>$fault</con2:input>
                                                        <con2:param name="servicioConFallo">
                                                            <con2:path>$amz_operacion_rest</con2:path>
                                                        </con2:param>
                                                        <con2:param name="codigoAmazon">
                                                            <con2:path>$amz_xml_fault//*:__type</con2:path>
                                                        </con2:param>
                                                        <con2:param name="mensajeAmazon">
                                                            <con2:path>$amz_xml_fault//*:message</con2:path>
                                                        </con2:param>
                                                    </con2:xsltTransform>
                                                </con1:expr>
                                            </con1:replace>
                                            <con3:report>
                                                <con2:comment>Reportar el usuario que no se pudo consultar</con2:comment>
                                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e8b</con2:id>
                                                <con3:expr>
                                                    <con2:xqueryText>$amz_xml_fault</con2:xqueryText>
                                                </con3:expr>
                                                <con3:labels>
                                                    <con3:key>Usuario</con3:key>
                                                    <con3:varName>amz_xml_request</con3:varName>
                                                    <con3:value>
                                                        <con2:xpathText>./*:Username</con2:xpathText>
                                                    </con3:value>
                                                </con3:labels>
                                            </con3:report>
                                        </con1:actions>
                                    </con1:case>
                                    <con1:default>
                                        <con1:replace contents-only="true" varName="body">
                                            <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                            <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e8a</con2:id>
                                            <con1:location>
                                                <con2:xpathText>.</con2:xpathText>
                                            </con1:location>
                                            <con1:expr>
                                                <con2:xsltTransform>
                                                    <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                                    <con2:input>$fault</con2:input>
                                                    <con2:param name="servicioConFallo">
                                                        <con2:path>$amz_operacion_rest</con2:path>
                                                    </con2:param>
                                                    <con2:param name="codigoAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                    <con2:param name="mensajeAmazon">
                                                        <con2:path>''</con2:path>
                                                    </con2:param>
                                                </con2:xsltTransform>
                                            </con1:expr>
                                        </con1:replace>
                                    </con1:default>
                                </con1:ifThenElse>
                            </con1:actions>
                        </con1:case>
                        <con1:default>
                            <con1:replace contents-only="true" varName="body">
                                <con2:comment>Crear fallo del servicio de acuerdo a la estructura definida para Nacional Monte de Piedad</con2:comment>
                                <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e89</con2:id>
                                <con1:location>
                                    <con2:xpathText>.</con2:xpathText>
                                </con1:location>
                                <con1:expr>
                                    <con2:xsltTransform>
                                        <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                        <con2:input>$fault</con2:input>
                                        <con2:param name="servicioConFallo">
                                            <con2:path>$amz_operacion_rest</con2:path>
                                        </con2:param>
                                        <con2:param name="codigoAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                        <con2:param name="mensajeAmazon">
                                            <con2:path>''</con2:path>
                                        </con2:param>
                                    </con2:xsltTransform>
                                </con1:expr>
                            </con1:replace>
                        </con1:default>
                    </con1:ifThenElse>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e88</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.N70788676.0.15e0b389659.N7e87">
            <con:stage id="_StageId-N3f57c7ff.N70788676.0.15e0b389659.N7e86" name="StageManejadorGeneralErrores">
                <con:comment>Manejador general para los errores ocurridos en el flujo de petición para la búsqueda de un usuario en AWSCognitoIdentityProviderService</con:comment>
                <con:context/>
                <con:actions>
                    <con1:replace contents-only="true" varName="body">
                        <con2:comment>Manejar error que no se pudo manejar en los manejadores a nivel stage</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e85</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xsltTransform>
                                <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                <con2:input>$fault</con2:input>
                                <con2:param name="servicioConFallo">
                                    <con2:path>'AdministradorIdentidades.buscarUsuario'</con2:path>
                                </con2:param>
                                <con2:param name="codigoAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                                <con2:param name="mensajeAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                            </con2:xsltTransform>
                        </con1:expr>
                    </con1:replace>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e84</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="response" name="response-N3f57c7ff.N70788676.0.15e0b389659.N7e83">
            <con:stage id="_StageId-N3f57c7ff.N70788676.0.15e0b389659.N7e82" name="StageRespuestaBuscarUsuario">
                <con:comment>Respuesta exitosa al buscar un usuario</con:comment>
                <con:context/>
                <con:actions>
                    <con2:reply>
                        <con2:comment>Notificar respuesta exitosa al buscar un usuario</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N70788676.0.15e0b389659.N7e81</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="request" name="request-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7fcf">
            <con:stage id="_StageId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7f59" name="StageValidarCabecera" errorHandler="error-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7f57">
                <con:comment>Validar la presencia de header en la petición.</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="nmph" namespace="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPStandardHeader"/>
                </con:context>
                <con:actions>
                    <con1:validate>
                        <con2:comment>Validar cabecera de petición contra la estructura de la cabecera definida para Nacional Monte de Piedad</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7f58</con2:id>
                        <con1:schema ref="Common/XSD/NMPStandardHeader"/>
                        <con1:schemaElement xmlns:nmp="http://servicios.montedepiedad.com.mx/NMP/Schema/NMPStandardHeader">nmp:headerMessage</con1:schemaElement>
                        <con1:varName>header</con1:varName>
                        <con1:location>
                            <con2:xpathText>./nmph:headerMessage</con2:xpathText>
                        </con1:location>
                    </con1:validate>
                    <con1:assign varName="aplicacion_consumidor">
                        <con2:comment>Obtener la abreviatura de la aplicacion consumidor de AMZParametrosGeneralesDVM, en base al ID consumidor (cabecera).</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7c16</con2:id>
                        <con1:expr>
                            <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "id_consumidor", $header//nmph:idConsumidor, "aplicacion_origen", "Error")</con2:xqueryText>
                        </con1:expr>
                    </con1:assign>
                    <con1:ifThenElse>
                        <con2:comment>Validar que el ID Consumidor se encuentra registrado en AMZParametrosGeneralesDVM.</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7c18</con2:id>
                        <con1:case id="_BranchId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7c15">
                            <con1:condition>
                                <con2:xqueryText>$aplicacion_consumidor = "Error"</con2:xqueryText>
                            </con1:condition>
                            <con1:actions>
                                <con1:Error>
                                    <con2:comment>Generar excepción en caso de que el ID Consumidor no se encuentra registrado en AMZParametrosGeneralesDVM.</con2:comment>
                                    <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7b0c</con2:id>
                                    <con1:errCode>USER_OSB-382505</con1:errCode>
                                    <con1:message>Error en los parámetros del mensaje: identificador de consumidor en la cabecera de petición no valido para consumir Amazon Cognito.</con1:message>
                                </con1:Error>
                            </con1:actions>
                        </con1:case>
                    </con1:ifThenElse>
                </con:actions>
            </con:stage>
            <con:stage id="_StageId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7ddd" name="StageObtenerParametrosAmazon" errorHandler="error-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7dd6">
                <con:comment>Obtener parametros de los DVM's AMZParametrosServiciosDVM  y AMZParametrosGeneralesDVM con los que se configurará la petición para los métodos de AWSCognitoIdentityProviderService.</con:comment>
                <con:context>
                    <con2:userNsDecl prefix="utl" namespace="http://servicios.montedepiedad.com.mx/NMP/Transformations/UtilidadesFecha"/>
                    <con2:dependencies>
                        <con2:importModule ref="Common/XQ/UtilidadServiciosAmazonXQ"/>
                    </con2:dependencies>
                </con:context>
                <con:actions>
                    <con1:assign varName="amz_operacion_rest">
                        <con2:comment>Obtener la operación del servicio AWSCognitoIdentityProviderService en base a la operación solicitada en el servicio AdministradorIdentidades</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7ddc</con2:id>
                        <con1:expr>
                            <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosServiciosDVM', "operacion_soap", $operation, "operacion_amazon", "")</con2:xqueryText>
                        </con1:expr>
                    </con1:assign>
                    <con1:assign varName="amz_id_cliente">
                        <con2:comment>Obtener el identificador del cliente requerido para la autenticación del usuario en AWSCognitoIdentityProviderService</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7a75</con2:id>
                        <con1:expr>
                            <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "client_id", "")</con2:xqueryText>
                        </con1:expr>
                    </con1:assign>
                    <con1:assign varName="amz_id_pool_usuario">
                        <con2:comment>Obtener el identificador del pool del usuario requerido por el servicio de AWSCognitoIdentityProviderService</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7ddb</con2:id>
                        <con1:expr>
                            <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "user_pool_id", "")</con2:xqueryText>
                        </con1:expr>
                    </con1:assign>
                    <con2:assign varName="amz_clave_secreta" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config">
                        <con5:comment xmlns:con5="http://www.bea.com/wli/sb/stages/config">Obtener la clave privada requerida para en la generación de la firma digital para AWS (Amazon Web Service)</con5:comment>
                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7dda</con5:id>
                        <con2:expr>
                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">fn-bea:lookupBasicCredentials('GestionIdentidades/Cognito/Resources/Service Account/AMZClaveSecretaSA')</con5:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con2:assign varName="amz_clave_acceso" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con4="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config">
                        <con5:comment xmlns:con5="http://www.bea.com/wli/sb/stages/config">Obtener la clave pública requerida para que el servicio de AWS (Amazon Web Service) valide la firma digital de la petición</con5:comment>
                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7dd9</con5:id>
                        <con2:expr>
                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">fn-bea:lookupBasicCredentials('GestionIdentidades/Cognito/Resources/Service Account/AMZClaveAccesoSA')</con5:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con1:assign varName="amz_diferencia_horario">
                        <con2:comment>Obtener la diferencia horaria de la región donde se encuentra el servicio AWSCognitoIdentityProviderService con la ciudad de México.</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7dd8</con2:id>
                        <con1:expr>
                            <con2:xqueryText>dvm:lookup('GestionIdentidades/Cognito/Resources/DVMs/AMZParametrosGeneralesDVM', "aplicacion_origen", $aplicacion_consumidor, "diferencia_zona_horaria", "")</con2:xqueryText>
                        </con1:expr>
                    </con1:assign>
                    <con1:assign varName="amz_fecha_hora">
                        <con2:comment>Obtener la fecha y hora actual de la región donde se encuentra el servicio AWSCognitoIdentityProviderService en su forma YYYYMMDDThhmmssZ (ISO8601).</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7dd7</con2:id>
                        <con1:expr>
                            <con2:xqueryText>utl:formatoFechaHoraISO8601(utl:agregarHorasEnFechaHora(fn:current-dateTime(), xs:int($amz_diferencia_horario)))</con2:xqueryText>
                        </con1:expr>
                    </con1:assign>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="response" name="response-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7fce"/>
        <con:pipeline type="error" name="error-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7f57">
            <con:stage id="_StageId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7f56" name="StageManejadorErroresValidarCabecera">
                <con:comment>Manejador de error en caso de excepciones en la validación de la cabecera la petición</con:comment>
                <con:context/>
                <con:actions>
                    <con1:replace contents-only="true" varName="body">
                        <con2:comment>Manejar excepción en la validación de la cabecera</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7f55</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xsltTransform>
                                <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                <con2:input>$fault</con2:input>
                                <con2:param name="servicioConFallo">
                                    <con2:path>fn:concat('AdministradorIdentidades.', $operation)</con2:path>
                                </con2:param>
                                <con2:param name="codigoAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                                <con2:param name="mensajeAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                            </con2:xsltTransform>
                        </con1:expr>
                    </con1:replace>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7f54</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7dd6">
            <con:stage id="_StageId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7dd5" name="StageManejadorErroresObtenerParametros">
                <con:comment>Manejador de error en caso de excepciones al obtener los parametros de los DVM's AMZParametrosServiciosDVM  y AMZParametrosGeneralesDVM</con:comment>
                <con:context/>
                <con:actions>
                    <con1:replace contents-only="true" varName="body">
                        <con2:comment>Manejar error al obtener valores de un DVM</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7dd4</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xsltTransform>
                                <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                <con2:input>$fault</con2:input>
                                <con2:param name="servicioConFallo">
                                    <con2:path>fn:concat('AdministradorIdentidades.', $operation)</con2:path>
                                </con2:param>
                                <con2:param name="codigoAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                                <con2:param name="mensajeAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                            </con2:xsltTransform>
                        </con1:expr>
                    </con1:replace>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7dd3</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="error-N3f57c7ff.N7b1b3e62.0.15e295a5474.N788a">
            <con:stage id="_StageId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7820" name="StageManejadorErrorGeneral">
                <con:comment>Manejador de error en caso de que los manejadores de excepción internos no pudieron manejar</con:comment>
                <con:context/>
                <con:actions>
                    <con1:replace contents-only="true" varName="body">
                        <con2:comment>Manejar excepción general</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N781f</con2:id>
                        <con1:location>
                            <con2:xpathText>.</con2:xpathText>
                        </con1:location>
                        <con1:expr>
                            <con2:xsltTransform>
                                <con2:resource ref="GestionIdentidades/Cognito/Resources/Transformations/TRAdministradorIdentidadesFault"/>
                                <con2:input>$fault</con2:input>
                                <con2:param name="servicioConFallo">
                                    <con2:path>fn:concat('AdministradorIdentidades.', $operation)</con2:path>
                                </con2:param>
                                <con2:param name="codigoAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                                <con2:param name="mensajeAmazon">
                                    <con2:path>''</con2:path>
                                </con2:param>
                            </con2:xsltTransform>
                        </con1:expr>
                    </con1:replace>
                    <con2:reply isError="true">
                        <con2:comment>Notificar el fallo al consumidor del servicio</con2:comment>
                        <con2:id>_ActionId-N3f57c7ff.N7b1b3e62.0.15e295a5474.N781e</con2:id>
                    </con2:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:flow>
            <con:pipeline-node name="PipelinePairValidacionesComunes">
                <con:comment>Validaciones comunes para toda las capacidades expuestas por el servicio.</con:comment>
                <con:request>request-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7fcf</con:request>
                <con:response>response-N3f57c7ff.N7b1b3e62.0.15e295a5474.N7fce</con:response>
            </con:pipeline-node>
            <con:branch-node type="operation" id="_FlowId-N3f57c7ff.6c3df5f4.0.15cd0d651c3.N7f68" name="BranchOperacionesCognitoAmazon">
                <con:comment>De acurerdo a la operación requerida por el consumidor el servicio proporciona la capacidad de gestionar la creación, borrado, actualización, activación y descactivación de usuarios en el proveedor de usuarios (Cognito) de Amazon.</con:comment>
                <con:context/>
                <con:branch-table>
                    <con:branch name="crearUsuario">
                        <con:operator>equals</con:operator>
                        <con:value/>
                        <con:flow>
                            <con:pipeline-node name="PipelinePairCrearUsuario">
                                <con:comment>Flujo de ejecución para gestionar la creación de un usuario en el proveedor de usuarios de Amazon (AWSCognitoIdentityProviderService)</con:comment>
                                <con:request>request-N3f57c7ff.594e9c22.0.15c8dc85eb7.N7f9a</con:request>
                                <con:response>response-N3f57c7ff.594e9c22.0.15c8dc85eb7.N7f99</con:response>
                            </con:pipeline-node>
                        </con:flow>
                    </con:branch>
                    <con:branch name="borrarUsuario">
                        <con:operator>equals</con:operator>
                        <con:value/>
                        <con:flow>
                            <con:pipeline-node name="PipelinePairBorrarUsuario">
                                <con:comment>Flujo de ejecución para gestionar el borrado de un usuario en el proveedor de usuarios de Amazon (AWSCognitoIdentityProviderService)</con:comment>
                                <con:request>request-N3f57c7ff.d04a762.0.15cea5ea7b1.N7fcf</con:request>
                                <con:response>response-N3f57c7ff.d04a762.0.15cea5ea7b1.N7fce</con:response>
                            </con:pipeline-node>
                        </con:flow>
                    </con:branch>
                    <con:branch name="autenticarUsuario">
                        <con:operator>equals</con:operator>
                        <con:value/>
                        <con:flow>
                            <con:pipeline-node name="PipelinePairAutenticarUsuario">
                                <con:comment>Flujo de ejecución para gestionar la autenticación de un usuario en el proveedor de usuarios de Amazon (AWSCognitoIdentityProviderService)</con:comment>
                                <con:request>request-N3f57c7ff.4474d43b.0.15cd6afa54e.N7fcf</con:request>
                                <con:response>response-N3f57c7ff.4474d43b.0.15cd6afa54e.N7fce</con:response>
                            </con:pipeline-node>
                        </con:flow>
                    </con:branch>
                    <con:branch name="actualizarParamAutenticacion">
                        <con:operator>equals</con:operator>
                        <con:value/>
                        <con:flow>
                            <con:pipeline-node name="PipelinePairActualizarParamAutenticacion">
                                <con:comment>Flujo de ejecución para gestionar la actualización de parametros de autenticación en el proveedor de usuarios de Amazon (AWSCognitoIdentityProviderService)</con:comment>
                                <con:request>request-N3f57c7ff.d04a762.0.15cea5ea7b1.N7f9a</con:request>
                                <con:response>response-N3f57c7ff.d04a762.0.15cea5ea7b1.N7f99</con:response>
                            </con:pipeline-node>
                        </con:flow>
                    </con:branch>
                    <con:branch name="activarUsuario">
                        <con:operator>equals</con:operator>
                        <con:value/>
                        <con:flow>
                            <con:pipeline-node name="PipelinePairActivarUsuario">
                                <con:comment>Flujo de ejecución para gestionar la activación de un usuario en el proveedor de usuarios de Amazon (AWSCognitoIdentityProviderService)</con:comment>
                                <con:request>request-N3f57c7ff.6f621bc4.0.15d097f84e3.N7ebe</con:request>
                                <con:response>response-N3f57c7ff.6f621bc4.0.15d097f84e3.N7e91</con:response>
                            </con:pipeline-node>
                        </con:flow>
                    </con:branch>
                    <con:branch name="desactivarUsuario">
                        <con:operator>equals</con:operator>
                        <con:value/>
                        <con:flow>
                            <con:pipeline-node name="PipelinePairDesactivarUsuario">
                                <con:comment>Flujo de ejecución para gestionar la desactivación de un usuario en el proveedor de usuarios de Amazon (AWSCognitoIdentityProviderService)</con:comment>
                                <con:request>request-N3f57c7ff.6f621bc4.0.15d097f84e3.N7da2</con:request>
                                <con:response>response-N3f57c7ff.6f621bc4.0.15d097f84e3.N7d75</con:response>
                            </con:pipeline-node>
                        </con:flow>
                    </con:branch>
                    <con:branch name="buscarUsuario">
                        <con:operator>equals</con:operator>
                        <con:value/>
                        <con:flow>
                            <con:pipeline-node name="PipelinePairBuscarUsuario">
                                <con:comment>Flujo de ejecución para gestionar la búsqueda de un usuario en el proveedor de usuarios de Amazon (AWSCognitoIdentityProviderService)</con:comment>
                                <con:request>request-N3f57c7ff.N70788676.0.15e0b389659.N7eb2</con:request>
                                <con:response>response-N3f57c7ff.N70788676.0.15e0b389659.N7e83</con:response>
                            </con:pipeline-node>
                        </con:flow>
                    </con:branch>
                    <con:default-branch>
                        <con:flow/>
                    </con:default-branch>
                </con:branch-table>
            </con:branch-node>
        </con:flow>
    </con:router>
</con:pipelineEntry>